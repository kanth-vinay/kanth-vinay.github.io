<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ActiveSTEM Middle School Series: Math Challenge</title>

  <!-- Social preview -->
  <meta property="og:title" content="ActiveSTEM Middle School Series: Math Challenge — Test Your Math Skills!">
  <meta property="og:description" content="A challenging 15-minute math quiz for middle school students from Active Learning Institute.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://activestem.org/assets/math-challenge-card.png">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700;900&family=Nunito:wght@400;700&display=swap" rel="stylesheet" />

  <!-- MathJax (optional) -->
  <script>
    (function () {
      var s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
      s.async = true;
      document.head.appendChild(s);
    })();
  </script>

  <style>
    :root{
      /* Blue theme */
      --blue: #007BFF;
      --blue-dark: #0056b3;
      --blue-light: #B3D7FF;
      --background: #F0F8FF; /* AliceBlue */
      --panel: #FFFFFF;
      --border: #A8D1FF;

      --black: #000000;
      --muted: #444444;
      --white: #FFFFFF;
      --shadow: rgba(0,0,0,0.08);

      --fh: 'Fredoka', system-ui, sans-serif;
      --fb: 'Nunito', system-ui, sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0; background:var(--background); color:var(--black);
      font-family:var(--fb); display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:20px;
    }
    .wrap{
      width:100%; max-width:960px; background:var(--panel); border:1px solid var(--border);
      border-radius:12px; padding:24px 32px; box-shadow:0 6px 20px var(--shadow); border-top:8px solid var(--blue);
    }

    .header{ text-align:center; margin-bottom:16px; }
    .header h1{ font-family:var(--fh); font-weight:900; color:var(--blue); font-size:2.35rem; margin:0 0 6px; }
    .header .sub{ color:var(--muted); max-width:740px; margin:0 auto; }
    .header a{ color:var(--blue); font-weight:900; text-decoration:none; }
    .header a:hover{ text-decoration:underline; }

    .meta{
      display:flex; gap:16px; flex-wrap:wrap; align-items:center;
      padding:12px 0; border-bottom:1px solid var(--border); margin-bottom:16px;
      position:sticky; top:0; z-index:10; background:var(--panel);
      margin-left:-32px; margin-right:-32px; padding-left:32px; padding-right:32px;
      box-shadow:0 2px 8px rgba(0,0,0,0.05); border-radius:0 0 12px 12px;
    }
    .timer,#answered{ font-variant-numeric:tabular-nums; font-weight:900; color:var(--blue-dark); }
    .legend{ margin-left:auto; color:var(--muted); font-size:.9rem; }
    #answered{ margin-left:0; }

    .btn{
      border:none; background:var(--blue); color:var(--white); padding:10px 20px;
      border-radius:10px; cursor:pointer; font-weight:900; font-family:var(--fb);
      box-shadow:0 3px 6px rgba(0,0,0,0.2); transition:transform .2s, background .2s;
    }
    .btn:hover{ background:var(--blue-dark); transform:translateY(-1px); }

    .question{ border-top:1px solid var(--border); padding:18px 0; }
    .qhead{ display:flex; justify-content:space-between; gap:12px; align-items:flex-start; }
    .qtitle{ font-weight:900; font-size:1.12rem; }
    .tag{ font-weight:900; font-size:.83rem; color:var(--muted); background:#E6F2FF; border:1px solid var(--blue-light); padding:4px 10px; border-radius:15px; }
    .choices{ margin-top:12px; }
    .choice{ display:flex; gap:10px; align-items:center; padding:8px 10px; border-radius:8px; cursor:pointer; transition:background .12s; }
    .choice:hover{ background:#E0EFFF; }
    input[type="radio"]{ accent-color:var(--blue); transform:scale(1.15); }

    .result{ font-weight:900; margin-top:8px; padding:6px 12px; border-radius:8px; display:inline-block; }
    .ok{ color:#1C6B1A; background:#E8F6E7; }
    .bad{ color:#8F2B2B; background:#FFE5E6; }

    .foot{ display:none; gap:12px; align-items:center; justify-content:center; padding-top:18px; border-top:1px solid var(--border); margin-top:16px; }
    .score{ font-family:var(--fh); font-weight:900; font-size:1.5rem; color:var(--blue); }

    #progress{ height:10px; background:#D6E9FF; border-radius:6px; overflow:hidden; margin:10px 0; flex-basis:100%; }
    #progress-fill{ height:100%; width:0; background:var(--blue); transition:width .3s ease; border-radius:6px; }

    .branding{ color:var(--muted); font-size:.8rem; margin-top:12px; text-align:center; width:100%; }

    /* name/grade modal */
    #completion-message, #initial-input-modal{ display:none; }
    #initial-input-modal.modal-overlay{ display:flex; }
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; display:none;
      justify-content:center; align-items:center; padding:10px;
    }
    .modal-content{
      background:var(--panel); color:var(--black); border-radius:16px; padding:24px;
      border:3px solid var(--blue); width:100%; max-width:840px; max-height:92vh;
      overflow:auto; box-shadow:0 8px 25px rgba(0,0,0,0.35); text-align:center;
    }
    .modal-content h2{ font-family:var(--fh); color:var(--blue); font-weight:900; font-size:2.1rem; margin:0 0 12px; }

    #initial-input-modal .modal-content{ max-width:560px; }
    #initial-input-modal input, #initial-input-modal select{
      width:100%; padding:12px; margin-bottom:16px; border:1px solid var(--border);
      border-radius:8px; font-size:1.05rem; font-family:var(--fb);
    }
    #initial-input-modal label{ display:block; text-align:left; margin-bottom:6px; font-weight:900; color:var(--blue-dark); }

    /* RESULTS modal */
    #results-modal .modal-content{ padding:18px; }
    #share-card{ display:flex; flex-direction:column; align-items:center; gap:12px; }
    #share-img{
      width:100%; max-width:900px; height:auto; max-height:70vh; object-fit:contain;
      border:2px solid var(--blue); border-radius:12px;
    }
    #stats{ display:none; }

    @media (max-width:768px){
      body{ padding:10px; }
      .wrap{ border-radius:0; border:none; border-top:8px solid var(--blue); padding:16px 18px; }
      .meta{ flex-direction:column; text-align:center; padding:10px 18px; margin-left:-18px; margin-right:-18px; }
      .header h1{ font-size:1.95rem; }
      .qtitle{ font-size:1.02rem; }
      #share-img{ max-height:60vh; }
    }
  </style>
</head>
<body>
  <div class="wrap" id="quiz">
    <div class="header">
      <h1>ActiveSTEM Middle School Series: Math Challenge</h1>
      <div class="sub">
        15 questions • 15 minutes • Grades 6–7 • Take it <strong>once per day</strong>. The share card shows date, a variant code, and an attempt status.
        <br />Hosted by <a href="https://activestem.org/" target="_blank">Active Learning Institute</a>. Runs entirely in your browser.
      </div>
    </div>

    <!-- Initial Input Modal -->
    <div id="initial-input-modal" class="modal-overlay">
      <div class="modal-content">
        <h2>Welcome, Math Challenger!</h2>
        <p style="margin:0 0 14px">
          This challenge has <strong>15 questions</strong> and a <strong>15-minute timer</strong>.
          Tell us your name and grade. Stored only on <em>this device</em>. One attempt per day.
        </p>
        <label for="student-name">Your Name</label>
        <input type="text" id="student-name" placeholder="Enter your name" required>
        <label for="student-grade">Your Grade Level</label>
        <select id="student-grade" required>
          <option value="">Select Grade</option>
          <option value="6">6th Grade</option>
          <option value="7">7th Grade</option>
          <option value="8">8th Grade</option>
          <option value="Other">Other</option>
        </select>
        <button id="initial-start-btn" class="btn" style="width:100%">Start the Challenge</button>
      </div>
    </div>

    <!-- Completed message -->
    <div id="completion-message">
      <h3>Today’s Attempt Already Completed</h3>
      <p>It looks like you’ve already finished today’s challenge on this device. Come back tomorrow for a new variant!</p>
    </div>

    <div id="quiz-content" style="display:none;">
      <div class="meta">
        <div><strong>Timer:</strong> <span class="timer" id="time">15:00</span></div>
        <div class="legend">Target: <strong>15 minutes</strong></div>
        <div id="answered" class="legend">Answered: 0/15</div>
        <div id="progress"><div id="progress-fill"></div></div>
      </div>

      <div id="quiz-container"></div>
      <div class="foot">
        <button id="check" class="btn">Submit & Grade</button>
        <div class="score" id="score"></div>
      </div>
    </div>

    <div class="branding">© Active Learning Institute LLC. Questions proposed by Prof. Vinay Kodipelly.</div>
    <p class="branding" style="margin-top:6px; font-size:.76rem">No calculator needed • Results computed in your browser • We don’t collect personal data</p>
  </div>

  <!-- RESULTS MODAL -->
  <div id="results-modal" class="modal-overlay">
    <div class="modal-content">
      <div id="share-card">
        <canvas id="share-canvas" width="1200" height="630" style="display:none;"></canvas>
        <img id="share-img" alt="Share card preview">
        <a id="download-card" class="btn" download="ActiveSTEM_Math_Challenge.png">Download Share Card</a>
      </div>
      <div id="stats" aria-live="polite">
        <h2 id="modal-title" style="margin:14px 0 0; font-family:var(--fh); color:var(--blue); font-weight:900;"></h2>
        <div id="modal-user-info" style="font-weight:900; margin:6px 0 0;"></div>
        <div style="display:flex; gap:18px; justify-content:center; margin-top:6px;">
          <div><strong>Score:</strong> <span id="modal-score"></span></div>
          <div><strong>Time:</strong> <span id="modal-time"></span></div>
        </div>
      </div>
      <button id="modal-close-btn" class="btn" style="margin-top:14px;">Close</button>
    </div>
  </div>

  <script>
    /* ===================== Utilities & Integrity Layer ===================== */

    // FNV-1a 32-bit
    function fnv1a(s){
      let h=0x811c9dc5; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=(h>>>0)*0x01000193; }
      return (h>>>0)>>>0;
    }
    function shortCode(num){ return num.toString(16).toUpperCase().padStart(6,'0').slice(0,6); }

    function getFingerprint(){
      const tz = String(new Date().getTimezoneOffset());
      const scr = (typeof screen!=='undefined') ? `${screen.width}x${screen.height}x${screen.colorDepth}` : 'na';
      const nav = (typeof navigator!=='undefined') ? `${navigator.platform}|${navigator.language}|${navigator.userAgent}` : 'na';
      return shortCode(fnv1a(`${tz}|${scr}|${nav}`));
    }

    function todayKey(){
      const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    // Seeded RNG (LCG)
    function makeRNG(seed){
      let state = (seed>>>0) || 1;
      return function(){ state = (1103515245 * state + 12345) >>> 0; return state/0xFFFFFFFF; };
    }
    function pickInt(rng, min,max){ return Math.floor(rng()*(max-min+1))+min; }

    // URL debug override
    const DEBUG = new URLSearchParams(location.search).get('debug')==='1';

    /* ===================== Question Generators (parametric) ===================== */

    function qPercentVariant(rng){
      const base = pickInt(rng, 40, 80);
      const d1 = [10,15,20,25][pickInt(rng,0,3)];
      const d2 = [5,10,12][pickInt(rng,0,2)];
      const p1 = base * (1 - d1/100);
      const final = Math.round(p1 * (1 - d2/100) * 100)/100;
      const optA = `$${final.toFixed(2)}`;
      const naive = Math.round(base * (1 - (d1+d2)/100) * 100)/100;
      const optB = `$${naive.toFixed(2)}`;
      const up = Math.round(p1 * (1 + d2/100) * 100)/100;
      const optC = `$${up.toFixed(2)}`;
      const optD = `$${base.toFixed(2)}`;
      return { id:'qP', answer:'A', tag:'Percents (Successive)', title:`A $${base} item is discounted ${d1}% and then ${d2}% off the new price. Final price?`, choices:{A:optA,B:optB,C:optC,D:optD} };
    }

    function qScaleVariant(rng){
      const scale = [40,50,60][pickInt(rng,0,2)];
      const cm = (pickInt(rng,24,42))/10; // 2.4–4.2 cm
      const dist = Math.round(cm*scale*10)/10; // 1 decimal
      const A = `${dist} km`, B = `${Math.max(0,dist-10)} km`, C = `${dist+10} km`, D = `${dist+20} km`;
      return { id:'qS', answer:'A', tag:'Scale Drawings', title:`Scale 1 cm : ${scale} km. Two towns are ${cm.toFixed(1)} cm apart on the map. Actual distance?`, choices:{A,B,C,D} };
    }

    function qCompositeAreaVariant(rng){
      const W = pickInt(rng,8,12), H = pickInt(rng,6,10);
      const cW = pickInt(rng,2,4), cH = pickInt(rng,2,4);
      const area = W*H - cW*cH;
      const A = `${area} cm²`;
      const B = `${W*H} cm²`;
      const C = `${W*H - (cW*cH - 2)} cm²`;
      const D = `${W*H - (cW*cH + 2)} cm²`;
      return { id:'qA', answer:'A', tag:'Geometry (Area)', title:`A ${W}×${H} cm rectangle has a ${cW}×${cH} cm corner cut out. What is the remaining area?`, choices:{A,B,C,D} };
    }

    function qTemperatureVariant(rng){
      const start = -pickInt(rng,3,8);
      const rise = pickInt(rng,10,15);
      const drop = pickInt(rng,6,10);
      const final = start + rise - drop;
      const A = `${final}°F`, B = `${final+1}°F`, C = `${final-1}°F`, D = `${final+3}°F`;
      return { id:'qT', answer:'A', tag:'Integers', title:`It is ${start}°F in the morning, the temperature rises ${rise}°F, then drops ${drop}°F. Final temperature?`, choices:{A,B,C,D} };
    }

    function qIQRVariant(rng){
      // Build 7-value increasing dataset with small random increments
      let vals=[pickInt(rng,2,6)];
      for(let i=0;i<6;i++){ vals.push(vals[vals.length-1] + pickInt(rng,1,4)); }
      // For n=7: median is vals[3]; Q1 = median of vals[0..2] = vals[1]; Q3 = median of vals[4..6] = vals[5]
      const IQR = vals[5] - vals[1];
      const A = `${IQR-1}`, B = `${IQR}`, C = `${IQR+1}`, D = `${IQR+2}`;
      return { id:'qI', answer:'B', tag:'Statistics (IQR)', title:`For the data set [${vals.join(', ')}], what is the IQR?`, choices:{A,B,C,D} };
    }

    /* ===================== App ===================== */

    document.addEventListener('DOMContentLoaded', function(){
      // Integrity keys
      const FP = getFingerprint();
      const DAY = todayKey();
      const ATTEMPT_KEY = `msQuiz:${DAY}:${FP}`;
      const storedAttempt = localStorage.getItem(ATTEMPT_KEY); // 'done'|'in-progress'|null
      const nameKey = `msQuizName:${FP}`;
      const priorName = localStorage.getItem(nameKey);

      const initialModal = document.getElementById('initial-input-modal');
      const startBtn = document.getElementById('initial-start-btn');
      const nameInput = document.getElementById('student-name');
      const gradeSel  = document.getElementById('student-grade');

      const quizContent = document.getElementById('quiz-content');
      const completionMsg = document.getElementById('completion-message');
      const quizContainer = document.getElementById('quiz-container');

      const timeEl = document.getElementById('time');
      const checkBtn = document.getElementById('check');
      const scoreEl = document.getElementById('score');

      const resultsModal = document.getElementById('results-modal');
      const modalTitleEl = document.getElementById('modal-title');
      const modalUserInfoEl = document.getElementById('modal-user-info');
      const modalScoreEl = document.getElementById('modal-score');
      const modalTimeEl = document.getElementById('modal-time');

      const shareCanvas = document.getElementById('share-canvas');
      const shareImg = document.getElementById('share-img');
      const downloadBtn = document.getElementById('download-card');

      const totalTime = 15 * 60;
      let remainingTime = totalTime, timer = null, inProgress = false;

      function shuffle(a, rngFn){
        for(let i=a.length-1;i>0;i--){
          const j = Math.floor((rngFn ? rngFn() : Math.random())*(i+1));
          [a[i],a[j]] = [a[j],a[i]];
        }
      }
      function updateProgress(){
        const answered = document.querySelectorAll('.question input[type="radio"]:checked').length;
        const totalQuestions = document.querySelectorAll('.question').length;
        document.getElementById('answered').textContent = `Answered: ${answered}/${totalQuestions}`;
        document.getElementById('progress-fill').style.width = `${(answered/totalQuestions)*100}%`;
      }
      function renderTime(s){ const m=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); timeEl.textContent=`${m}:${ss}`; }
      function startTimer(){
        if (timer) return;
        timer = setInterval(()=>{ remainingTime=Math.max(0,remainingTime-1); renderTime(remainingTime); if(!remainingTime){ clearInterval(timer); timer=null; checkBtn.click(); } },1000);
      }

      // Entry gate (once per day), allow override with ?debug=1
      if (!DEBUG && storedAttempt === 'done') { completionMsg.style.display='block'; }
      else { initialModal.style.display='flex'; }

      startBtn.onclick = () => {
        const name = nameInput.value.trim();
        const grade = gradeSel.value;
        if(!name || !grade){ alert('Please enter your name and select your grade.'); return; }

        localStorage.setItem('studentName', name);
        localStorage.setItem('studentGrade', grade);
        localStorage.setItem(nameKey, name);
        localStorage.setItem(ATTEMPT_KEY, 'in-progress'); // mark attempt for the day

        initialModal.style.display='none';
        quizContent.style.display='block';
        document.querySelector('.foot').style.display='flex';
        startQuiz();
      };

      function buildQuizData(rng){
        // ----- 5 parametric items -----
        const qParam = [
          qPercentVariant(rng),
          qScaleVariant(rng),
          qCompositeAreaVariant(rng),
          qTemperatureVariant(rng),
          qIQRVariant(rng),
        ];

        // ----- 10 static items (value-based grading) -----
        const qStatic = [
          { id: 'q2',  answer: 'C', tag: 'Number System', title: 'Compute: \\(-15 - (-8) + 3\\)', choices: { A:'-26', B:'-10', C:'-4', D:'-20' } },
          { id: 'q4',  answer: 'A', tag: 'Circles', title: 'A circle has circumference \\(16\\pi\\) cm. What is the area?', choices: { A:'\\(64\\pi\\,\\text{cm}^2\\)', B:'\\(8\\pi\\,\\text{cm}^2\\)', C:'\\(32\\pi\\,\\text{cm}^2\\)', D:'\\(256\\pi\\,\\text{cm}^2\\)' } },
          { id: 'q5',  answer: 'C', tag: 'Expressions', title: 'Simplify: \\(5(x-2) - (3x - 4)\\)', choices: { A:'\\(2x - 14\\)', B:'\\(8x - 6\\)', C:'\\(2x - 6\\)', D:'\\(2x + 2\\)' } },
          { id: 'q6',  answer: 'B', tag: 'Probability', title: 'A bag has 5 red, 3 green, 2 blue marbles. Probability of green then blue without replacement?', choices: { A:'1/18', B:'1/15', C:'1/20', D:'1/12' } },
          { id: 'q7',  answer: 'A', tag: 'Fraction Ops', title: 'Evaluate: \\(\\tfrac{5}{6} \\div \\tfrac{2}{3}\\)', choices: { A:'\\(1\\tfrac{1}{4}\\)', B:'\\(\\tfrac{5}{9}\\)', C:'\\(1\\tfrac{1}{3}\\)', D:'\\(\\tfrac{4}{5}\\)' } },
          { id: 'q8',  answer: 'D', tag: 'Equations', title: 'Solve: \\(2x + 8 = -6\\)', choices: { A:'\\(x=1\\)', B:'\\(x=-1\\)', C:'\\(x=7\\)', D:'\\(x=-7\\)' } },
          { id: 'q9',  answer: 'B', tag: 'Geometry', title: 'A right triangle has legs 6 cm and 8 cm. What is the perimeter?', choices: { A:'20 cm', B:'24 cm', C:'30 cm', D:'48 cm' } },
          { id: 'q11', answer: 'B', tag: 'Unit Rate', title: 'A car travels 210 miles in 3.5 hours. Average speed?', choices: { A:'55 mph', B:'60 mph', C:'65 mph', D:'70 mph' } },
          { id: 'q14', answer: 'C', tag: 'Inequalities', title: 'Which value satisfies \\(-3x + 7 < -5\\)?', choices: { A:'2', B:'3', C:'5', D:'4' } },
          { id: 'q15', answer: 'B', tag: 'Angle Rules', title: 'Two angles are supplementary. One is \\(40^\\circ\\) more than the other. Measure of the smaller angle?', choices: { A:'\\(50^\\circ\\)', B:'\\(70^\\circ\\)', C:'\\(110^\\circ\\)', D:'\\(90^\\circ\\)' } },
        ];

        const all = qParam.concat(qStatic);
        // Stable shuffle using seeded RNG
        shuffle(all, rng);
        return all;
      }

      function startQuiz(){
        inProgress = true;
        quizContainer.innerHTML='';

        // Build seed AFTER we know name/grade (for per-user/day variants)
        const name = localStorage.getItem('studentName') || '';
        const grade = localStorage.getItem('studentGrade') || '';
        const variantSeed = fnv1a(`${DAY}|${FP}|${name}|${grade}`);
        const rng = makeRNG(variantSeed);
        const VARIANT_CODE = `V-${shortCode(variantSeed)}`;

        const qs = buildQuizData(rng);
        // Render
        qs.forEach((q,idx)=>{
          const correctValue = q.choices[q.answer]; // value-based answer
          // Shuffle options with seeded rng
          const entries = Object.values(q.choices);
          shuffle(entries, rng);

          const sec=document.createElement('section');
          sec.className='question';
          sec.dataset.correct=correctValue;
          sec.dataset.tag=q.tag;

          const optsHTML = entries.map(v=>`<label class="choice"><input type="radio" name="${q.id}" value="${v}"> ${v}</label>`).join('');

          sec.innerHTML=`
            <div class="qhead">
              <div class="qtitle">${idx+1}) ${q.title}</div>
              <span class="tag">${q.tag}</span>
            </div>
            <div class="choices">${optsHTML}</div>
            <div class="result" aria-live="polite"></div>
          `;
          quizContainer.appendChild(sec);
        });

        if(window.MathJax && window.MathJax.typeset){ window.MathJax.typeset(); }
        const totalQuestions = document.querySelectorAll('.question').length;

        remainingTime = totalTime; renderTime(remainingTime); updateProgress(); startTimer();

        // Expose for grading/share
        window.__QUIZ_META__ = { VARIANT_CODE, variantSeed, name, grade, rng };
      }

      checkBtn.onclick = () => {
        inProgress=false; if(timer) clearInterval(timer); timer=null;

        let correct=0;
        document.querySelectorAll('.question').forEach(q=>{
          const chosen = q.querySelector('input[type="radio"]:checked');
          const result = q.querySelector('.result');
          if(chosen && chosen.value === q.dataset.correct){
            result.textContent='Correct'; result.className='result ok'; correct++;
          }else{
            result.textContent='Incorrect'; result.className='result bad';
          }
        });

        const totalQuestions = document.querySelectorAll('.question').length;
        const scoreText = `${correct}/${totalQuestions}`;
        scoreEl.textContent = `Score: ${scoreText}`;

        const secs = totalTime - remainingTime;
        const mm = Math.floor(secs/60), ss = secs%60;
        const timeStr = `${mm} min, ${ss} sec`;

        const pct = (correct/totalQuestions)*100;
        let band='Keep Practicing!';
        if(pct>=90) band='Math Whiz!';
        else if(pct>=75) band='Excellent Work!';
        else if(pct>=60) band='Great Job!';

        const name = localStorage.getItem('studentName') || 'Student';
        const gradeRaw = localStorage.getItem('studentGrade') || 'N/A';
        const gradeText = (gradeRaw === 'Other') ? 'Middle School' : `Grade ${gradeRaw}`;

        // Attempt status & flags
        let statusBadge = 'FIRST ATTEMPT';
        if (!DEBUG && storedAttempt === 'done') statusBadge = 'RETAKE';
        if (!DEBUG && storedAttempt === null && priorName && priorName !== name) statusBadge = 'NAME CHANGED';
        if (!('localStorage' in window)) statusBadge = 'NO STORAGE';

        const resetFlag = (!DEBUG && storedAttempt === null && localStorage.getItem('msQuizCompleted') === 'true') ? 'RESET DETECTED' : '';

        // minimal hidden stats (fallback)
        document.getElementById('stats').style.display='none';
        document.getElementById('modal-title').textContent = `Result: ${band}`;
        document.getElementById('modal-user-info').textContent = `${name} — ${gradeText}`;
        document.getElementById('modal-score').textContent = scoreText;
        document.getElementById('modal-time').textContent = timeStr;

        // Share card
        const { VARIANT_CODE } = window.__QUIZ_META__ || { VARIANT_CODE:'V-000000' };
        renderShareCard({
          name, grade: gradeText, band, scoreText, timeStr,
          variant: VARIANT_CODE, status: statusBadge, resetFlag, day: DAY, fp: FP
        });

        resultsModal.style.display='flex';
        resultsModal.scrollTop = 0;

        // Lock for the day
        localStorage.setItem('msQuizCompleted','true'); // legacy flag (for reset detection)
        localStorage.setItem(ATTEMPT_KEY, 'done');
        localStorage.setItem('msQuizEver','true');
      };

      document.addEventListener('change', e => { if(e.target.matches('input[type="radio"]')) updateProgress(); });
      document.getElementById('modal-close-btn').onclick = () => resultsModal.style.display='none';
      resultsModal.onclick = (e)=>{ if(e.target===resultsModal) resultsModal.style.display='none'; };

      window.addEventListener('beforeunload', (e)=>{ if(inProgress){ e.preventDefault(); e.returnValue=''; } });

      /* --------- Share Card (1200x630) - Blue theme + proof lines --------- */
      function renderShareCard({ name, grade, band, scoreText, timeStr, variant, status, resetFlag, day, fp }){
        const W=1200, H=630;
        const c=shareCanvas, ctx=c.getContext('2d');
        c.width=W; c.height=H;

        // Background (light blue)
        ctx.fillStyle='#F0F8FF'; ctx.fillRect(0,0,W,H);

        // Subtle anti-edit watermark (diagonal lines)
        ctx.save();
        ctx.globalAlpha = 0.06;
        ctx.strokeStyle = '#0056b3';
        ctx.lineWidth = 1;
        for(let x=-H; x<W+H; x+=24){
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x-H, H);
          ctx.stroke();
        }
        ctx.restore();

        // Rounded border
        ctx.strokeStyle='#007BFF'; ctx.lineWidth=8; roundRect(ctx,12,12,W-24,H-24,22); ctx.stroke();

        // Blue header bar
        ctx.fillStyle='#007BFF'; roundRect(ctx,12,12,W-24,110,22); ctx.fill();

        // Title (white for contrast)
        ctx.fillStyle='#FFFFFF';
        ctx.font='900 58px Fredoka, sans-serif';
        ctx.textAlign='center';
        ctx.fillText('ActiveSTEM Math Challenge', W/2, 88);

        // Badge ribbon
        ctx.fillStyle='#0056b3'; roundRect(ctx, W/2-260, 140, 520, 70, 20); ctx.fill();
        ctx.fillStyle='#FFFFFF'; ctx.font='900 44px Fredoka, sans-serif'; ctx.fillText(band, W/2, 188);

        // Name & grade
        ctx.fillStyle='#000000'; ctx.font='900 56px Fredoka, sans-serif'; ctx.fillText(`${name} — ${grade}`, W/2, 280);

        // Score
        ctx.fillStyle='#0056b3'; ctx.font='900 150px Fredoka, sans-serif'; ctx.fillText(scoreText, W/2, 410);

        // Time
        ctx.fillStyle='#000000'; ctx.font='900 56px Fredoka, sans-serif'; ctx.fillText(timeStr, W/2, 480);

        // Proof line (variant • date • device)
        ctx.fillStyle='#445065'; ctx.font='700 26px Nunito, sans-serif';
        ctx.fillText(`${variant} • ${day} • FP:${fp}`, W/2, 515);

        // Status ribbon (top-right)
        function tag(x,y,w,h,text,bg){
          ctx.fillStyle = bg; roundRect(ctx,x,y,w,h,14); ctx.fill();
          ctx.fillStyle = '#FFFFFF'; ctx.font='900 28px Fredoka, sans-serif'; ctx.textAlign='center';
          ctx.fillText(text, x+w/2, y+38);
        }
        const badgeColor = (status==='FIRST ATTEMPT') ? '#2E7D32' : (status==='RETAKE' ? '#C62828' : '#6A1B9A');
        tag(W-260, 24, 232, 56, status, badgeColor);

        // Optional flag if we suspect storage reset
        if (resetFlag){
          ctx.fillStyle='#C62828'; ctx.font='700 24px Nunito, sans-serif';
          ctx.fillText(resetFlag, W/2, 552);
        }

        // Footer
        ctx.fillStyle='#555555'; ctx.font='700 28px Nunito, sans-serif'; ctx.fillText('Active Learning Institute • activestem.org', W/2, 595);

        // export
        const url = c.toDataURL('image/png');
        shareImg.src = url;
        downloadBtn.href = url;

        function roundRect(c2,x,y,w,h,r){
          c2.beginPath();
          c2.moveTo(x+r,y);
          c2.arcTo(x+w,y,x+w,y+h,r);
          c2.arcTo(x+w,y+h,x,y+h,r);
          c2.arcTo(x,y+h,x,y,r);
          c2.arcTo(x,y,x+w,y,r);
          c2.closePath();
        }
      }
    });
  </script>
</body>
</html>
