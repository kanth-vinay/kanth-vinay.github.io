<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ActiveSTEM ACT Math Challenge preview</title>

  <meta property="og:title" content="ActiveSTEM ACT Math Challenge preview">
  <meta property="og:description" content="A rigorous 25-minute preview from the upcoming ActiveSTEM ACT Math Challenge Series.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://activestem.org/assets/math-challenge-card.png"> <meta name="twitter:card" content="summary_large_image">

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet" />

  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      startup: { typeset: false }
    };
  </script>
  <script id="mathjax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>

  <style>
    :root{
      --primary-dark:#2D3748;--primary-darker:#1A202C;--text-dark:#1A202C;--bg-light:#F7FAFC;--panel:#FFF;--card-gray:#EDF2F7;
      --accent-green:#2F855A;--accent-red:#C53030;--shadow:rgba(45,55,72,.1);--border:#CBD5E0;--radius:4px;
      --fh:'Poppins',system-ui,-apple-system,Segoe UI,sans-serif;--fb:'Inter',system-ui,-apple-system,Segoe UI,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg-light);color:var(--text-dark);font-family:var(--fb);display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:20px}
    .wrap{width:100%;max-width:960px;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:24px 32px;box-shadow:0 8px 24px var(--shadow);border-top:4px solid var(--primary-dark)}
    .header{margin-bottom:8px}
    .header h1{font-family:var(--fh);font-weight:700;color:var(--primary-dark);font-size:1.9rem;line-height:1.2;margin:0 0 6px;letter-spacing:.2px}
    .header .sub{opacity:.9;max-width:760px;margin:0}
    .header .note{margin-top:6px;font-size:.95rem;opacity:.9}
    a{color:var(--primary-dark);text-decoration:none}
    a:hover{text-decoration:underline}
    .meta{display:flex;gap:16px;flex-wrap:wrap;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);margin:12px 0 16px;position:sticky;top:0;z-index:10;background:var(--panel);margin-left:-32px;margin-right:-32px;padding-left:32px;padding-right:32px;box-shadow:0 2px 8px rgba(45,55,72,.05)}
    .timer,#answered{font-variant-numeric:tabular-nums;font-weight:600;color:var(--primary-dark)}
    .legend{margin-left:auto;opacity:.9;font-size:.95rem}
    #answered{margin-left:0}
    .btn{border:1px solid var(--primary-dark);background:var(--primary-dark);color:#fff;padding:10px 18px;border-radius:var(--radius);cursor:pointer;font-weight:600;font-family:var(--fb);box-shadow:0 2px 8px rgba(45,55,72,.08);transition:transform .15s,background .15s,color .15s}
    .btn.ghost{background:transparent;color:var(--primary-dark);border-color:var(--border)}
    .btn:hover{background:var(--primary-darker);transform:translateY(-1px)}
    .btn.ghost:hover{background:var(--card-gray)}
    .question{border-top:1px solid var(--border);padding:18px 0}
    .qhead{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .qtitle{font-weight:600;font-size:1.05rem}
    .tag{font-weight:600;font-size:.8rem;color:var(--primary-dark);background:var(--card-gray);border:1px solid var(--border);padding:3px 8px;border-radius:var(--radius)}
    .choices{margin-top:12px}
    .choice{display:flex;gap:10px;align-items:center;padding:8px 10px;border-radius:var(--radius);cursor:pointer;transition:background .12s}
    .choice:hover{background:var(--bg-light)}
    input[type="radio"]{accent-color:var(--primary-dark);transform:scale(1.12)}
    .result{font-weight:600;margin-top:8px;padding:6px 10px;border-radius:var(--radius);display:inline-block;border:1px solid transparent}
    .ok{color:var(--accent-green);background:#F0FFF4;border-color:#B7E4C7}
    .bad{color:var(--accent-red);background:#FFF5F5;border-color:#FED7D7}
    .foot{display:none;gap:12px;align-items:center;justify-content:center;padding-top:16px;border-top:1px solid var(--border);margin-top:16px}
    .score{font-family:var(--fh);font-weight:700;font-size:1.25rem;color:var(--primary-dark)}
    #progress{height:8px;background:#E2E8F0;border-radius:var(--radius);overflow:hidden;margin:8px 0;flex-basis:100%}
    #progress-fill{height:100%;width:0;background:var(--primary-dark);transition:width .3s ease;border-radius:var(--radius)}
    .branding{opacity:.7;font-size:.85rem;margin-top:12px;text-align:center;width:100%}
    #completion-message,#initial-input-modal{display:none}
    #initial-input-modal.modal-overlay{display:flex}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:none;justify-content:center;align-items:center;padding:12px}
    .modal-content{background:var(--panel);color:var(--text-dark);border-radius:var(--radius);padding:22px;border:1px solid var(--border);width:100%;max-width:720px;max-height:92vh;overflow:auto;box-shadow:0 12px 36px var(--shadow);text-align:left}
    .modal-content h2{font-family:var(--fh);color:var(--primary-dark);font-weight:700;font-size:1.6rem;margin:0 0 10px}
    .modal-content p{margin:0 0 14px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .modal-content label{display:block;margin-bottom:6px;font-weight:600;color:var(--primary-darker)}
    .modal-content input,.modal-content select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:1rem;font-family:var(--fb);background:#fff}
    #results-modal .modal-content{padding:16px}
    #share-card{display:flex;flex-direction:column;align-items:center;gap:12px}
    #share-img{width:100%;max-width:900px;height:auto;max-height:70vh;object-fit:contain;border:1px solid var(--border);border-radius:var(--radius);background:#fff}
    .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    @media (max-width:768px){
      body{padding:12px}
      .wrap{border-radius:var(--radius);border:1px solid var(--border);padding:16px 18px}
      .meta{flex-direction:column;text-align:left;padding:10px 18px;margin-left:-18px;margin-right:-18px}
      .header h1{font-size:1.6rem}
      .qtitle{font-size:1rem}
      .form-row{grid-template-columns:1fr}
      #share-img{max-height:60vh}
    }
  </style>
</head>
<body>
  <div class="wrap" id="quiz">
    <div class="header">
      <h1>ActiveSTEM ACT Math Challenge preview</h1>
      <p class="sub">
        Grades 9–12 • 20 questions • 25 minutes • <strong>One attempt per device</strong>.<br>
        Enter the <strong>PIN from the WhatsApp announcement</strong> to begin. Your share card shows date, variant, device code, PIN, and attempt status.
      </p>
      <p class="note">
        This quiz is a <em>preview</em> from the upcoming <strong>ActiveSTEM ACT Math Challenge Series</strong>—a full, rigorous course for motivated high school students.
      </p>
    </div>

    <div id="initial-input-modal" class="modal-overlay">
      <div class="modal-content">
        <h2>Welcome to the ACT Math Challenge</h2>
        <p>Enter your details to begin. Data stays on <em>this device</em>. The share card includes your proof line.</p>

        <div class="form-row">
          <div>
            <label for="student-name">Your Name</label>
            <input type="text" id="student-name" placeholder="e.g., Alex Johnson" required>
          </div>
          <div>
            <label for="student-grade">Grade Level</label>
            <select id="student-grade" required>
              <option value="">Select Grade</option>
              <option value="9">9th Grade</option>
              <option value="10">10th Grade</option>
              <option value="11">11th Grade</option>
              <option value="12">12th Grade</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="daily-pin">PIN (from WhatsApp)</label>
          <input type="text" id="daily-pin" placeholder="4-digit PIN" inputmode="numeric" pattern="[0-9]*" required>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end;">
          <button id="initial-start-btn" class="btn">Start the Challenge</button>
        </div>
      </div>
    </div>

    <div id="completion-message">
      <h3 style="font-family:var(--fh); color:var(--primary-dark); margin:0 0 6px;">Challenge Completed</h3>
      <p style="margin:0;">You’ve already finished this preview on this device.</p>
    </div>

    <div id="quiz-content" style="display:none;">
      <div class="meta">
        <div><strong>Timer:</strong> <span class="timer" id="time">25:00</span></div>
        <div class="legend"><strong>Target:</strong> 25 minutes</div>
        <div id="answered" class="legend">Answered: 0/20</div>
        <div id="progress"><div id="progress-fill"></div></div>
      </div>

      <div id="quiz-container"></div>
      <div class="foot">
        <button id="check" class="btn">Submit & Grade</button>
        <div class="score" id="score"></div>
      </div>
    </div>

    <div class="branding">© Active Learning Institute (ALI). Questions proposed by Prof. Vinay Kodipelly.</div>
    <p class="branding" style="margin-top:6px; font-size:.83rem">No calculator needed • Results computed in your browser • We don’t collect personal data</p>
  </div>

  <div id="results-modal" class="modal-overlay">
    <div class="modal-content">
      <div id="share-card">
        <canvas id="share-canvas" width="1200" height="630" style="display:none;"></canvas>
        <img id="share-img" alt="Share card preview">
        <div class="actions">
          <a id="download-card" class="btn" download="ActiveSTEM_ACT_Math_Preview.png">Download Share Card</a>
          <a id="wa-share" class="btn ghost">Share on WhatsApp</a>
          <button id="modal-close-btn" class="btn ghost">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ================= Utilities & Helpers ================= */
    const GENERAL_PIN = '2718'; // <-- CHANGE PIN IF NEEDED
    const DEBUG = new URLSearchParams(location.search).get('debug') === '1';

    function fnv1a(s) { let h = 0x811c9dc5; for (let i = 0; i < s.length; i++) { h ^= s.charCodeAt(i); h = (h >>> 0) * 0x01000193; } return (h >>> 0) >>> 0; }
    function shortCode(num) { return num.toString(16).toUpperCase().padStart(6, '0').slice(0, 6); }
    function getFingerprint() {
      const tz = String(new Date().getTimezoneOffset());
      const scr = (typeof screen !== 'undefined') ? `${screen.width}x${screen.height}x${screen.colorDepth}` : 'na';
      const nav = (typeof navigator !== 'undefined') ? `${navigator.platform}|${navigator.language}|${navigator.userAgent}` : 'na';
      return shortCode(fnv1a(`${tz}|${scr}|${nav}`));
    }
    function chicagoDateKey() {
      const parts = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Chicago', year: 'numeric', month: '2-digit', day: '2-digit' }).formatToParts(new Date());
      const get = k => parts.find(p => p.type === k).value;
      return `${get('year')}-${get('month')}-${get('day')}`;
    }
    function makeRNG(seed) { let state = (seed >>> 0) || 1; return function () { state = (1103515245 * state + 12345) >>> 0; return state / 0xFFFFFFFF; }; }
    function pickInt(rng, min, max) { return Math.floor(rng() * (max - min + 1)) + min; }
    
    function whenMathJaxReady() {
      return new Promise(resolve => {
        if (window.MathJax && MathJax.typesetPromise) return resolve();
        const t = setInterval(() => { if (window.MathJax && MathJax.typesetPromise) { clearInterval(t); resolve(); } }, 50);
        setTimeout(() => { clearInterval(t); resolve(); }, 7000); // fail-safe
      });
    }
    async function typeset(el) { await whenMathJaxReady(); try { await MathJax.typesetPromise(el ? [el] : undefined); } catch (e) { } }

    /* ============== Parametric Question Generators (8) ============== */
    // 1. Quadratic Formula
    function qQuadratic(rng) {
        const a = 1;
        const b = pickInt(rng, -5, 5) * 2; // even b for simpler discriminant
        const c = pickInt(rng, -10, 10);
        const discriminant = b * b - 4 * a * c;
        let ans, ansTex;
        if (discriminant < 0) {
            const real = -b / (2 * a);
            const imag = Math.sqrt(-discriminant) / (2 * a);
            ansTex = `\\(${real} \\pm ${imag.toFixed(2)}i\\)`;
        } else {
            const root1 = (-b + Math.sqrt(discriminant)) / (2 * a);
            const root2 = (-b - Math.sqrt(discriminant)) / (2 * a);
            ansTex = `\\(${root1.toFixed(2)}\\) and \\(${root2.toFixed(2)}\\)`;
        }
        return {
            id: 'qQuad', answer: 'A', tag: 'Algebra',
            title: `What are the solutions to \\( ${a}x^2 + ${b}x + ${c} = 0 \\)?`,
            choices: { A: ansTex, B: `\\(${b} \\pm \\sqrt{${discriminant}}\\)`, C: `No real solutions`, D: `\\(x = ${-c/b}\\)`, E: `\\(x=1, x=-1\\)` }
        };
    }
    // 2. Composite Functions
    function qCompositeFunc(rng) {
        const a = pickInt(rng, 2, 5);
        const b = pickInt(rng, 1, 4);
        const c = pickInt(rng, 2, 4);
        const x = pickInt(rng, 1, 3);
        const ans = a * (c * x * x) + b; // f(g(x))
        return {
            id: 'qCompFunc', answer: 'A', tag: 'Functions',
            title: `If \\(f(x) = ${a}x + ${b}\\) and \\(g(x) = ${c}x^2\\), what is \\(f(g(${x}))\\)?`,
            choices: { A: `\\(${ans}\\)`, B: `\\(${c * Math.pow(a * x + b, 2)}\\)`, C: `\\(${a * c * x + b}\\)`, D: `\\(${ans - b}\\)`, E: `\\(${ans + a}\\)` }
        };
    }
    // 3. Circle Equation
    function qCircleEq(rng) {
        const h = pickInt(rng, -5, 5);
        const k = pickInt(rng, -5, 5);
        const r = pickInt(rng, 3, 8);
        const r2 = r * r;
        const signH = h > 0 ? '-' : '+';
        const signK = k > 0 ? '-' : '+';
        return {
            id: 'qCircle', answer: 'A', tag: 'Coordinate Geometry',
            title: `What is the equation of a circle with center \\((${h}, ${k})\\) and radius \\(${r}\\)?`,
            choices: {
                A: `\\((x ${signH} ${Math.abs(h)})^2 + (y ${signK} ${Math.abs(k)})^2 = ${r2}\\)`,
                B: `\\((x ${signH} ${Math.abs(h)})^2 + (y ${signK} ${Math.abs(k)})^2 = ${r}\\)`,
                C: `\\((x + ${h})^2 + (y + ${k})^2 = ${r2}\\)`,
                D: `\\(x^2 + y^2 = ${r2}\\)`,
                E: `\\((x - ${r})^2 + (y - ${r})^2 = ${h*h + k*k}\\)`
            }
        };
    }
    // 4. Basic Trigonometry (SOHCAHTOA)
    function qSohCahToa(rng) {
        const angle = [30, 45, 60][pickInt(rng, 0, 2)];
        const opp = pickInt(rng, 5, 10);
        const hyp = (opp / Math.sin(angle * Math.PI / 180)).toFixed(2);
        return {
            id: 'qTrig', answer: 'A', tag: 'Trigonometry',
            title: `In a right triangle, one angle is \\(${angle}^{\\circ}\\) and the side opposite is \\(${opp}\\) units. What is the length of the hypotenuse?`,
            choices: { A: `\\(${hyp}\\)`, B: `\\(${(opp / Math.tan(angle * Math.PI / 180)).toFixed(2)}\\)`, C: `\\(${opp * 2}\\)`, D: `\\(${opp / 2}\\)`, E: `\\(${opp * Math.cos(angle * Math.PI / 180).toFixed(2)}\\)` }
        };
    }
    // 5. Probability
    function qProbability(rng) {
        const red = pickInt(rng, 3, 8);
        const blue = pickInt(rng, 4, 9);
        const total = red + blue;
        const ans = `\\(\\frac{${red}}{${total}}\\)`;
        return {
            id: 'qProb', answer: 'A', tag: 'Statistics & Probability',
            title: `A bag contains \\(${red}\\) red marbles and \\(${blue}\\) blue marbles. What is the probability of drawing a red marble?`,
            choices: { A: ans, B: `\\(\\frac{${blue}}{${total}}\\)`, C: `\\(\\frac{${red}}{${blue}}\\)`, D: `\\(\\frac{${blue}}{${red}}\\)`, E: `\\(1\\)` }
        };
    }
    // 6. Complex Number Multiplication
    function qComplexMult(rng) {
        const a = pickInt(rng, 2, 5), b = pickInt(rng, 2, 6);
        const c = pickInt(rng, 1, 4), d = pickInt(rng, 3, 7);
        const real = a * c - b * d;
        const imag = a * d + b * c;
        return {
            id: 'qComplex', answer: 'A', tag: 'Number & Quantity',
            title: `What is \\((${a} + ${b}i)(${c} + ${d}i)\\)? Assume \\(i = \\sqrt{-1}\\).`,
            choices: { A: `\\(${real} + ${imag}i\\)`, B: `\\(${a*c + b*d} + ${a*d + b*c}i\\)`, C: `\\(${a+c} + ${b+d}i\\)`, D: `\\(${real} - ${imag}i\\)`, E: `\\(${a*c - b*d}\\)` }
        };
    }
    // 7. Matrix Determinant (2x2)
    function qMatrixDet(rng) {
        const a = pickInt(rng, -5, 5), b = pickInt(rng, -5, 5);
        const c = pickInt(rng, -5, 5), d = pickInt(rng, -5, 5);
        const det = a * d - b * c;
        return {
            id: 'qMatrix', answer: 'A', tag: 'Algebra',
            title: `Find the determinant of the matrix \\(\\begin{pmatrix} ${a} & ${b} \\\\ ${c} & ${d} \\end{pmatrix}\\).`,
            choices: { A: `\\(${det}\\)`, B: `\\(${a*d + b*c}\\)`, C: `\\(${a*c - b*d}\\)`, D: `\\(${a+d - (b+c)}\\)`, E: `\\(0\\)` }
        };
    }
    // 8. Logarithm Property
    function qLogRule(rng) {
        const b = pickInt(rng, 2, 5);
        const x = pickInt(rng, 2, 4);
        const y = pickInt(rng, 3, 5);
        const ans = x + y;
        return {
            id: 'qLog', answer: 'A', tag: 'Algebra',
            title: `If \\(\\log_{${b}} M = ${x}\\) and \\(\\log_{${b}} N = ${y}\\), what is \\(\\log_{${b}} (MN)\\)?`,
            choices: { A: `\\(${ans}\\)`, B: `\\(${x*y}\\)`, C: `\\(${y-x}\\)`, D: `\\(\\frac{${x}}{${y}}\\)` , E: `Cannot be determined` }
        };
    }

    /* ============== Static Questions (12) ============== */
    const STATIC_QS = [
        { id:'s1', answer:'C', tag:'Geometry', title:'A cylinder has a volume of \\(128\\pi\\,\\text{cm}^3\\) and a height of \\(8\\,\\text{cm}\\). What is the diameter of its base?', choices:{A:'\\(2\\,\\text{cm}\\)', B:'\\(4\\,\\text{cm}\\)', C:'\\(8\\,\\text{cm}\\)', D:'\\(16\\,\\text{cm}\\)', E:'\\(32\\,\\text{cm}\\)'} },
        { id:'s2', answer:'B', tag:'Functions', title:'The graph of \\(f(x) = (x-3)^2 + 5\\) is a parabola. What are the coordinates of its vertex?', choices:{A:'\\((-3, -5)\\)', B:'\\((3, 5)\\)', C:'\\((3, -5)\\)', D:'\\((-3, 5)\\)', E:'\\((5, 3)\\)'} },
        { id:'s3', answer:'A', tag:'Statistics & Probability', title:'A survey of 200 students finds 120 take Spanish and 90 take French. If 40 take both, how many students take neither?', choices:{A:'30', B:'40', C:'50', D:'70', E:'10'} },
        { id:'s4', answer:'D', tag:'Algebra', title:'If \\(3^{2x-1} = 27\\), what is the value of \\(x\\)?', choices:{A:'\\(0.5\\)', B:'\\(1\\)', C:'\\(1.5\\)', D:'\\(2\\)', E:'\\(2.5\\)'} },
        { id:'s5', answer:'B', tag:'Number & Quantity', title:'What is the distance in the standard \\((x,y)\\) coordinate plane between the points \\((-2, 5)\\) and \\((4, -3)\\)?', choices:{A:'\\(8\\)', B:'\\(10\\)', C:'\\(12\\)', D:'\\(14\\)', E:'\\(\\sqrt{28}\\)'} },
        { id:'s6', answer:'E', tag:'Trigonometry', title:'Which of the following is equivalent to \\(\\frac{\\sin^2\\theta + \\cos^2\\theta}{\\sec\\theta}\\)?', choices:{A:'\\(\\sin\\theta\\)', B:'\\(\\tan\\theta\\)', C:'\\(\\csc\\theta\\)', D:'\\(\\sec\\theta\\)', E:'\\(\\cos\\theta\\)'} },
        { id:'s7', answer:'C', tag:'Geometry', title:'The lengths of the sides of a triangle are 5, 12, and 13. What is the area of the triangle?', choices:{A:'\\(25\\)', B:'\\(26\\)', C:'\\(30\\)', D:'\\(60\\)', E:'\\(65\\)'} },
        { id:'s8', answer:'B', tag:'Algebra', title:'A line in the \\(xy\\)-plane passes through \\((1, 5)\\) and has a slope of \\(-\\frac{2}{3}\\). Which point is also on the line?', choices:{A:'\\((2, 3)\\)', B:'\\((4, 3)\\)', C:'\\((3, 4)\\)', D:'\\((-2, 7)\\)', E:'\\((0, 4)\\)'} },
        { id:'s9', answer:'D', tag:'Functions', title:'The value of a car depreciates by 20% each year. If it was purchased for $25,000, what is its value after 3 years?', choices:{A:'$10,000', B:'$11,800', C:'$12,500', D:'$12,800', E:'$15,000'} },
        { id:'s10', answer:'A', tag:'Statistics & Probability', title:'The mean of 5 numbers is 15. When a 6th number is added, the new mean is 16. What is the 6th number?', choices:{A:'21', B:'20', C:'16', D:'15', E:'10'} },
        { id:'s11', answer:'C', tag:'Geometry', title:'What is the measure, in degrees, of an interior angle of a regular octagon?', choices:{A:'108', B:'120', C:'135', D:'144', E:'150'} },
        { id:'s12', answer:'E', tag:'Number & Quantity', title:'If \\(x\\) and \\(y\\) are integers such that \\(x > 0\\) and \\(xy = 24\\), what is the minimum possible value of \\(x+y\\)?', choices:{A:'25', B:'14', C:'11', D:'-11', E:'10'} }
    ];

    /* ===================== App ===================== */
    document.addEventListener('DOMContentLoaded', function () {
      const FP = getFingerprint();
      const ATTEMPT_KEY = `actQuizOnce:${FP}`;
      const storedAttempt = localStorage.getItem(ATTEMPT_KEY);
      const nameKey = `actQuizName:${FP}`;

      const initialModal = document.getElementById('initial-input-modal');
      const startBtn = document.getElementById('initial-start-btn');
      const nameInput = document.getElementById('student-name');
      const gradeSel = document.getElementById('student-grade');
      const pinInput = document.getElementById('daily-pin');
      const quizContent = document.getElementById('quiz-content');
      const completionMsg = document.getElementById('completion-message');
      const quizContainer = document.getElementById('quiz-container');
      const timeEl = document.getElementById('time');
      const checkBtn = document.getElementById('check');
      const scoreEl = document.getElementById('score');
      const resultsModal = document.getElementById('results-modal');
      const shareCanvas = document.getElementById('share-canvas');
      const shareImg = document.getElementById('share-img');
      const downloadBtn = document.getElementById('download-card');
      const TOTAL_QUESTIONS = 20;

      const totalTime = 25 * 60;
      let remainingTime = totalTime, timer = null, inProgress = false;

      function shuffle(a, rngFn) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor((rngFn ? rngFn() : Math.random()) * (i + 1));[a[i], a[j]] = [a[j], a[i]]; } }
      function updateProgress() {
        const answered = document.querySelectorAll('.question input[type="radio"]:checked').length;
        document.getElementById('answered').textContent = `Answered: ${answered}/${TOTAL_QUESTIONS}`;
        document.getElementById('progress-fill').style.width = `${(answered / TOTAL_QUESTIONS) * 100}%`;
      }
      function renderTime(s) { const m = String(Math.floor(s / 60)).padStart(2, '0'); const ss = String(s % 60).padStart(2, '0'); timeEl.textContent = `${m}:${ss}`; }
      function startTimer() { if (timer) return; timer = setInterval(() => { remainingTime = Math.max(0, remainingTime - 1); renderTime(remainingTime); if (!remainingTime) { clearInterval(timer); timer = null; checkBtn.click(); } }, 1000); }

      if (!DEBUG && storedAttempt === 'done') { completionMsg.style.display = 'block'; }
      else { initialModal.style.display = 'flex'; }

      startBtn.onclick = () => {
        const name = nameInput.value.trim();
        const grade = gradeSel.value;
        const pin = (pinInput.value || '').trim();
        if (!name || !grade || !pin) { alert('Please enter your name, grade, and the PIN.'); return; }
        if (pin !== GENERAL_PIN && !DEBUG) { alert('Incorrect PIN. Check the WhatsApp post.'); return; }

        localStorage.setItem('studentName', name);
        localStorage.setItem('studentGrade', grade);
        localStorage.setItem('actQuizPin', pin);
        localStorage.setItem(nameKey, name);
        localStorage.setItem(ATTEMPT_KEY, 'in-progress');

        initialModal.style.display = 'none';
        quizContent.style.display = 'block';
        document.querySelector('.foot').style.display = 'flex';
        startQuiz();
      };

      function buildQuizData(rng) {
        const params = [qQuadratic(rng), qCompositeFunc(rng), qCircleEq(rng), qSohCahToa(rng), qProbability(rng), qComplexMult(rng), qMatrixDet(rng), qLogRule(rng)];
        const stat = [...STATIC_QS];
        const all = params.concat(stat); // 8 + 12 = 20
        shuffle(all, rng);
        return all;
      }

      function startQuiz() {
        inProgress = true;
        quizContainer.innerHTML = '';
        const name = localStorage.getItem('studentName') || '';
        const grade = localStorage.getItem('studentGrade') || '';
        const FPx = getFingerprint();
        const variantSeed = fnv1a(`${FPx}|${name}|${grade}|ActiveSTEM-ACT-Challenge`);
        const rng = makeRNG(variantSeed);
        const VARIANT_CODE = `V-${shortCode(variantSeed)}`;

        const qs = buildQuizData(rng);
        qs.forEach((q, idx) => {
          const opts = Object.entries(q.choices).map(([key, html]) => ({ key, html }));
          shuffle(opts, rng);
          const sec = document.createElement('section');
          sec.className = 'question';
          sec.dataset.correct = q.answer;
          const optsHTML = opts.map(o => `<label class="choice"><input type="radio" name="${q.id}" value="${o.key}"> ${o.html}</label>`).join('');
          sec.innerHTML = `<div class="qhead"><div class="qtitle">${idx + 1}) ${q.title}</div><span class="tag">${q.tag}</span></div><div class="choices">${optsHTML}</div><div class="result" aria-live="polite"></div>`;
          quizContainer.appendChild(sec);
        });

        typeset(quizContainer);
        remainingTime = totalTime; renderTime(remainingTime); updateProgress(); startTimer();
        window.__QUIZ_META__ = { VARIANT_CODE, variantSeed, name, grade, rng, FP: FPx };
      }

      checkBtn.onclick = () => {
        inProgress = false; if (timer) clearInterval(timer); timer = null;
        let correct = 0;
        document.querySelectorAll('.question').forEach(q => {
          const chosen = q.querySelector('input[type="radio"]:checked');
          const result = q.querySelector('.result');
          if (chosen && chosen.value === q.dataset.correct) { result.textContent = 'Correct'; result.className = 'result ok'; correct++; }
          else { result.textContent = 'Incorrect'; result.className = 'result bad'; }
        });

        const totalQuestions = document.querySelectorAll('.question').length;
        const scoreText = `${correct}/${totalQuestions}`;
        scoreEl.textContent = `Score: ${scoreText}`;
        const secs = totalTime - remainingTime;
        const mm = Math.floor(secs / 60), ss = secs % 60;
        const timeStr = `${mm} min, ${ss} sec`;
        const pct = (correct / totalQuestions) * 100;
        let band = 'Keep Practicing!'; if (pct >= 90) band = 'Top Scorer!'; else if (pct >= 75) band = 'Excellent Work!'; else if (pct >= 60) band = 'Great Job!';

        const name = localStorage.getItem('studentName') || 'Student';
        const gradeRaw = localStorage.getItem('studentGrade') || 'N/A';
        const gradeText = (gradeRaw === 'Other') ? 'High School' : `Grade ${gradeRaw}`;
        const FP = getFingerprint();
        const ATTEMPT_KEY = `actQuizOnce:${FP}`;
        let statusBadge = 'FIRST ATTEMPT';
        if (!DEBUG && localStorage.getItem(ATTEMPT_KEY) === 'done') statusBadge = 'RETAKE';
        if (!('localStorage' in window)) statusBadge = 'NO STORAGE';
        const pin = localStorage.getItem('actQuizPin') || '----';

        const { VARIANT_CODE } = window.__QUIZ_META__ || { VARIANT_CODE: 'V-000000' };
        const DAY = chicagoDateKey();
        renderShareCard({ name, grade: gradeText, band, scoreText, timeStr, variant: VARIANT_CODE, status: statusBadge, day: DAY, fp: FP, pin });

        const wa = document.getElementById('wa-share');
        if (wa) {
          const txt = encodeURIComponent(`ActiveSTEM ACT Math Challenge — Quiz Preview\n${name} — ${gradeText}\nScore: ${scoreText} in ${timeStr}\n${band}\n${VARIANT_CODE} • ${DAY} • FP:${FP} • PIN:${pin}`);
          wa.onclick = () => window.open(`https://wa.me/?text=${txt}`, '_blank');
        }

        localStorage.setItem(ATTEMPT_KEY, 'done');
        const resultsModal = document.getElementById('results-modal');
        resultsModal.style.display = 'flex';
        resultsModal.scrollTop = 0;
        document.getElementById('modal-close-btn').onclick = () => resultsModal.style.display = 'none';
        resultsModal.onclick = (e) => { if (e.target === resultsModal) resultsModal.style.display = 'none'; };
      };

      document.addEventListener('change', e => { if (e.target.matches('input[type="radio"]')) updateProgress(); });
      window.addEventListener('beforeunload', e => { if (inProgress) { e.preventDefault(); e.returnValue = ''; } });

      function renderShareCard({ name, grade, band, scoreText, timeStr, variant, status, day, fp, pin }) {
        const W = 1200, H = 630; const c = shareCanvas, ctx = c.getContext('2d'); c.width = W; c.height = H;
        ctx.fillStyle = '#F7FAFC'; ctx.fillRect(0, 0, W, H);
        ctx.strokeStyle = '#CBD5E0'; ctx.lineWidth = 4; roundRect(ctx, 12, 12, W - 24, H - 24, 6); ctx.stroke();
        ctx.fillStyle = '#1A202C'; roundRect(ctx, 12, 12, W - 24, 96, 6); ctx.fill();
        ctx.fillStyle = '#FFF'; ctx.font = '700 46px Poppins, sans-serif'; ctx.textAlign = 'center';
        ctx.fillText('ActiveSTEM ACT Math Challenge — Quiz Preview', W / 2, 80);
        
        function tag(x,y,w,h,text,bg){ctx.fillStyle=bg;roundRect(ctx,x,y,w,h,6);ctx.fill();ctx.fillStyle='#FFF';ctx.font='700 24px Poppins, sans-serif';ctx.textAlign='center';ctx.fillText(text,x+w/2,y+32);}
        const badgeColor=(status==='FIRST ATTEMPT') ? '#2F855A' : (status==='RETAKE' ? '#C53030' : '#6A1B9A');
        tag(W-232,18,214,48,status,badgeColor);

        ctx.fillStyle = '#2D3748'; ctx.font = '700 52px Poppins, sans-serif'; ctx.fillText(`${name} — ${grade}`, W / 2, 250);
        ctx.fillStyle = '#1A202C'; ctx.font = '700 140px Poppins, sans-serif'; ctx.fillText(scoreText, W / 2, 390);
        ctx.fillStyle = '#2D3748'; ctx.font = '700 48px Poppins, sans-serif'; ctx.fillText(timeStr, W / 2, 465);
        ctx.fillStyle = '#EDF2F7'; roundRect(ctx, W / 2 - 260, 150, 520, 64, 6); ctx.fill();
        ctx.fillStyle = '#1A202C'; ctx.font = '700 36px Poppins, sans-serif'; ctx.fillText(band, W / 2, 195);
        ctx.fillStyle = '#2D3748'; ctx.font = '600 24px Inter, sans-serif'; ctx.fillText(`${variant} • ${day} • FP:${fp} • PIN:${pin}`, W / 2, 510);
        ctx.fillStyle = '#2D3748'; ctx.globalAlpha = .85; ctx.font = '600 24px Inter, sans-serif'; ctx.fillText('Active Learning Institute • activestem.org', W / 2, 590); ctx.globalAlpha = 1;
        const url = c.toDataURL('image/png'); document.getElementById('share-img').src = url; downloadBtn.href = url;
        function roundRect(c2, x, y, w, h, r) { c2.beginPath(); c2.moveTo(x + r, y); c2.arcTo(x + w, y, x + w, y + h, r); c2.arcTo(x + w, y + h, x, y + h, r); c2.arcTo(x, y + h, x, y, r); c2.arcTo(x, y, x + w, y, r); c2.closePath(); }
      }
    });

    window.addEventListener('load', () => typeset(document.body));
  </script>
</body>
</html>
