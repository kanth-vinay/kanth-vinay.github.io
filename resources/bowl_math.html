<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Middle School Math Bowl — Competition</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Poppins:wght@700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Luckiest+Guy&display=swap" rel="stylesheet">

  <!-- reveal.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.6.1/reset.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.6.1/reveal.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.6.1/theme/white.min.css">

  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"/>

  <style>
    :root{
      --navy:#1A237E;
      --green:#4CAF50;
      --light-bg:#F5F7FF;
      --white:#FFFFFF;
      --dark:#333;
      --border:#e0e3ec;
      --gold:#FFB300;
      --shadow:rgba(0,0,0,.08);
      --leaderboard-bg:#f9f9fc;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    body{ font-family:'Inter',system-ui,sans-serif; color:var(--dark); background:var(--light-bg); }
    h1,h2,h3,h4,h5,h6{ font-family:'Poppins','Inter',sans-serif; font-weight:800; color:var(--navy); }

    /* PATCH 1: Remove horizontal scroll */
    html, body, .reveal { overflow-x: hidden; }

    /* Currency spans (ignored by KaTeX) */
    .currency.no-math{ font-weight:700; font-variant-numeric: tabular-nums; }

    .reveal h1.title-arcade{
      font-family: 'Luckiest Guy','Bangers','Poppins','Inter',sans-serif;
      font-weight: 900;
      font-size: clamp(60px, 6.2vw, 96px);
      letter-spacing: 1px;                 /* tighter tracking improves legibility */
      word-spacing: 0.5px;
      line-height: .92;
      text-transform: uppercase;

      /* HIGH CONTRAST "sticker" text */
      -webkit-text-fill-color: #FFFFFF;     /* pure white fill for max contrast */
      color: #FFFFFF;                       /* fallback */
      -webkit-text-stroke: 4px #0A0F2D;     /* darker, thinner outline (less fill loss) */
      text-shadow:
        0 2px 0 #0A0F2D,                    /* crisp local edge */
        0 10px 24px rgba(0,0,0,.25);        /* soft drop shadow */

      /* Gentle float only */
      animation: titleArcadeFloat 5s ease-in-out infinite;
      display: inline-block;
      margin-top: 18px;
      position: relative;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.18));
    }
    .reveal h1.title-arcade .title-line{ display:block; }
    .reveal h1.title-arcade::before{
      content:"";
      position:absolute;
      inset:-8px -14px;
      z-index:-1;
      background: radial-gradient(ellipse at center, rgba(2,6,23,.40), rgba(2,6,23,.15) 60%, transparent 75%);
      filter: blur(4px);
      border-radius: 16px;
    }
    @keyframes titleArcadeFloat{ 0%{transform:translateY(0)} 50%{transform:translateY(-2px)} 100%{transform:translateY(0)} }
    @media (prefers-reduced-motion: reduce){
      .reveal h1.title-arcade{ animation:none }
    }

    .reveal h1.title-arcade::after{
      content:"";
      position:absolute;
      left:0; right:0;
      height:8px;
      bottom:-16px;
      margin-inline:auto;
      width:100%;                       /* match title width exactly */
      max-width: 980px;                 /* but don’t exceed on huge screens */
      background: linear-gradient(90deg,#1A237E,#FFB300,#4CAF50,#E91E63,#1A237E);
      background-size: 200% 100%;
      border-radius:999px;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      animation: underlineSweep 3.6s ease-in-out infinite;
      opacity:.75;
    }
    @keyframes underlineSweep{
      0%{ background-position: 0% 0; transform:scaleX(.98); }
      50%{ background-position: 100% 0; transform:scaleX(1.02); }
      100%{ background-position: 0% 0; transform:scaleX(.98); }
    }

    /* PATCH 1: Ensure flip buttons always clickable */
    .flash-actions button { pointer-events:auto }

    /* Fixed layout */
    .fixed-header{
      position:fixed; top:0; left:0; right:0; height:60px;
      background:var(--navy); color:var(--white);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px 0 30px; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.2);
    }
    .header-title{ font-family:'Poppins',sans-serif; font-size:24px; font-weight:800; letter-spacing:.5px; }
    .header-info{ font-size:16px; font-weight:600; opacity:.9; }
    /* === Hamburger + Slide Navigator === */
    .hamburger{
      all: unset; cursor: pointer;
      font-family: 'Inter', system-ui, sans-serif; font-weight: 900;
      font-size: 22px; line-height: 1; padding: 8px 10px;
      border-radius: 8px; border: 2px solid rgba(255,255,255,.6);
      color: #fff; background: rgba(255,255,255,.08);
      transition: background .2s, transform .1s; margin-right: 10px;
    }
    .hamburger:active{ transform: scale(.98); }
    .nav-backdrop{
      position: fixed; inset: 0; background: rgba(2,6,23,.45);
      opacity: 0; pointer-events: none; transition: opacity .18s ease; z-index: 1200;
    }
    .nav-drawer{
      position: fixed; top: 0; left: 0; bottom: 0; width: 320px;
      transform: translateX(-100%); transition: transform .22s ease;
      background: #0A0F2D; color: #fff; z-index: 1201; box-shadow: 6px 0 24px rgba(0,0,0,.25);
      display: flex; flex-direction: column;
    }
    .nav-drawer.open{ transform: translateX(0); }
    .nav-backdrop.open{ opacity: 1; pointer-events: auto; }
    .nav-drawer header{
      padding: 16px 18px; font-weight: 900; letter-spacing: .08em;
      border-bottom: 1px solid rgba(255,255,255,.15);
    }
    .nav-drawer .nav-list{ list-style: none; padding: 0; margin: 0; overflow-y: auto; }
    .nav-drawer .nav-list li{ border-bottom: 1px solid rgba(255,255,255,.08); }
    .nav-drawer .nav-list a{
      display: block; padding: 12px 18px; color: #E8EAFF; text-decoration: none; font-weight: 700;
    }
    .nav-drawer .nav-list a:hover{ background: rgba(255,255,255,.08); }

    .fixed-footer{
      position:fixed; bottom:0; left:0; right:0; height:45px;
      background:var(--dark); color:var(--white); display:flex; align-items:center; justify-content:center;
      font-size:14px; font-weight:600; z-index:1000;
    }
    .fixed-footer a{ color:var(--gold); text-decoration:none; margin-left:8px; }

    .fixed-leaderboard{
      position:fixed; top:60px; bottom:45px; right:0; width:25%;
      background:var(--leaderboard-bg); border-left:2px solid var(--border); z-index:500;
      padding:20px; overflow-y:auto; display:flex; flex-direction:column;
    }

    /* Slides container (left 75%) */
    .reveal{
      position:fixed; top:60px; bottom:45px; left:0; right:25%;
      width:75%; height:auto;
    }
    .reveal .slides{ text-align:left; }
    .reveal .slides section{ padding:20px 40px; }
    .reveal .slides section.full-width{ width:100% !important; left:0 !important; padding:40px; text-align:center; }

    /* Leaderboard */
    .fixed-leaderboard h3{ text-align:center; margin:0 0 15px 0; font-size:22px; }

    #double-points-toggle,
    #reset-r1-btn,
    #mode-individuals,
    #mode-teams,
    #tense-toggle{
      font-family:'Inter',sans-serif; font-weight:700; font-size:14px;
      border:2px solid var(--gold); background:var(--white); color:var(--gold);
      border-radius:8px; padding:8px 12px; cursor:pointer; margin-bottom:10px; transition:.2s;
    }
    #double-points-toggle:hover,
    #reset-r1-btn:hover,
    #mode-individuals:hover,
    #mode-teams:hover{ background:var(--gold); color:var(--navy); }
    #double-points-toggle.active{ background:var(--gold); color:var(--navy); border-color:var(--navy); }

    /* Tense toggle distinct look */
    #tense-toggle{ border-color:var(--navy); color:var(--navy); }
    #tense-toggle:hover{ background:var(--navy); color:#fff; }
    #tense-toggle.active{ background:var(--navy); color:#fff; }

    #leaderboard-container{ display:flex; flex-direction:column; gap:12px; position:relative; }

    .leaderboard-team{
      background:var(--white); border:1px solid var(--border); border-radius:10px; padding:12px 15px;
      box-shadow:var(--shadow) 0 4px 12px;
      display:grid; grid-template-areas:"rank info buttons" "rank score buttons";
      grid-template-columns:30px 1fr auto; align-items:center; gap:0 10px;
      transition:border-left .5s ease, box-shadow .3s ease, background-color .3s ease;
      border-left:5px solid transparent;
    }
    .leaderboard-team.rank-1{ border-left-color:var(--gold); }
    .leaderboard-team.rank-2{ border-left-color:#C0C0C0; }
    .leaderboard-team.rank-3{ border-left-color:#cd7f32; }

    .team-rank{ grid-area:rank; font-size:24px; font-weight:800; color:var(--navy); text-align:center; }
    .team-info{ grid-area:info; font-size:18px; font-weight:700; color:var(--dark); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .team-score{ grid-area:score; font-size:16px; font-weight:800; color:var(--green); }

    .score-buttons{ grid-area:buttons; display:flex; flex-direction:column; gap:5px; }
    .score-buttons button{
      font-family:'Inter',sans-serif; font-weight:700; font-size:13px; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; width:80px; transition:.2s;
    }
    .score-buttons button.add{ background:#E8F5E9; color:#1B5E20; }
    .score-buttons button.add:hover{ background:var(--green); color:#fff; }
    .score-buttons button.sub{ background:#FFEBEE; color:#B71C1C; }
    .score-buttons button.sub:hover{ background:#D32F2F; color:#fff; }
    .score-buttons .swap{ background:#f3e8ff; color:#6b21a8; font-weight:800; }
    .score-buttons .swap:hover{ background:#6b21a8; color:#fff; }

    /* Question typography */
    .reveal .slides section h2{ font-size:28px; }
    .reveal .slides section p{ font-size:28px; line-height:1.4; margin-top:15px; }
    .question-math{ font-size:44px; font-weight:700; text-align:center; color:var(--green); margin-top:30px; padding:20px; }
    .question-math-smaller{ font-size:36px; font-weight:700; text-align:center; color:var(--green); margin-top:20px; }
    .reveal .slides section ul{ margin-top:20px; }
    .reveal .slides section li{ font-size:24px; line-height:1.5; margin-bottom:10px; }

    /* Chips + small hint text */
    .chip-row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:20px}
    .chip{font-size:14px;font-weight:700;padding:6px 10px;border-radius:999px;background:#E8F0FE;color:#1A237E;border:1px solid #cdd6f9;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .chip.lead{font-size:22px;padding:10px 16px;border-width:2px;background:#e0e7ff;color:#0b102f;box-shadow:0 2px 8px rgba(0,0,0,.10)}
    .mentor-chip{display:inline-block;margin-top:10px;font-size:14px;font-weight:700;padding:6px 12px;border-radius:999px;background:#FFFFFF;color:#7c2d12;border:1px solid #FDBA74;box-shadow:0 1px 4px rgba(0,0,0,.06);opacity:.95}
    .dp-label{display:inline-block;margin:6px auto 10px;padding:6px 12px;font-weight:900;color:#B45309;background:#FFF7ED;border:2px solid #FDBA74;border-radius:999px;box-shadow:0 2px 6px rgba(0,0,0,.08)}

    /* Smaller inline Double Points pill when used inside a heading */
    .reveal .slides section h2.has-pill{ display:inline-flex; align-items:center; gap:12px; }
    .reveal .slides section h2.has-pill .dp-label{ font-size:.6em; padding:4px 8px; border-width:2px; border-radius:10px; margin-left:4px; }
    .hint{font-size:16px;color:#555;text-align:center;margin-top:8px}

    /* Flashcard flip UI for question slides */
    .flashcard-wrap{perspective:1200px;margin-top:12px}
    .flashcard{position:relative;transform-style:preserve-3d;transition:transform .6s;min-height:160px}
    .flashcard.flipped{transform:rotateY(180deg)}
    .flash-face{backface-visibility:hidden;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow) 0 6px 18px;padding:18px 20px}
    .flash-front{}
    .flash-back{position:absolute;top:0;left:0;width:100%;transform:rotateY(180deg)}
    .flash-actions{margin-top:10px;text-align:center}
    .flash-actions .reveal-btn,.flash-actions .back-btn{font-family:'Inter',sans-serif;font-weight:700;font-size:14px;border:2px solid var(--gold);background:#fff;color:var(--gold);border-radius:8px;padding:8px 12px;cursor:pointer;transition:.2s}
    .flash-actions .reveal-btn:hover,.flash-actions .back-btn:hover{background:var(--gold);color:var(--navy)}
    .solution-title{font-weight:800;color:var(--navy);margin-bottom:6px}
    .solution-body{font-size:20px;line-height:1.5;color:#222}

    /* PARTICIPANT HUD (trim — no giant BUZZ overlay) */
    .qhud{position:fixed; inset:60px 25% 45px 0; pointer-events:none; z-index:700;}
    .qh-top{display:flex; gap:10px; align-items:center; justify-content:center; margin-top:6px}
    .qh-chip{padding:6px 12px; border-radius:999px; font-weight:800; font-size:14px; background:#fff; border:2px solid var(--navy); color:var(--navy); box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .qh-chip.qh-points{border-color:var(--gold); color:var(--gold)}
    .qh-bottom{position:absolute; left:0; right:0; bottom:12px; display:flex; align-items:center; justify-content:space-between; gap:16px; padding:0 18px}
    .qh-progress{flex:1; height:10px; background:#e9ecf7; border-radius:999px; overflow:hidden}
    #qh-progress-bar{height:100%; width:0%; background:linear-gradient(90deg,#4CAF50,#FFB300);}
    .qh-current{font-weight:800; color:var(--navy); background:#fff; border:2px solid var(--navy); padding:6px 10px; border-radius:10px}


    /* Inline BUZZ pill (shows only when Tense Mode is ON) */
    .buzz-pill{
      display:inline-block;margin-top:12px;padding:8px 16px;border-radius:10px;
      background:#E8F5E9;border:2px solid var(--green);color:#1B5E20;
      font-weight:900;font-size:28px; box-shadow:0 4px 12px rgba(0,0,0,.06);
      animation:buzzPulse 1s infinite;
    }
    @keyframes buzzPulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}

    /* Permanently hide legacy big overlays if any remain */
    #qh-buzz,#qh-locked{ display:none !important; }

    /* Full-screen feedback flashes */
    .fb{position:fixed;inset:0;display:none;opacity:0;z-index:9999;transition:opacity .12s}
    #fb-good{background:rgba(76,175,80,.85)}
    #fb-bad{background:rgba(211,47,47,.85)}


    /* Double Points banner on question slides */
    .dp-banner{position:absolute;top:8px;left:50%;transform:translateX(-50%);background:#fff;border:3px solid var(--gold);color:var(--gold);padding:6px 12px;border-radius:12px;font-weight:900;box-shadow:0 4px 12px rgba(0,0,0,.1);display:none}

    /* Animated gradient for title/intro sections */
    .animated-bg{position:relative;overflow:hidden}
    .animated-bg::before{content:"";position:absolute;inset:0;background:linear-gradient(45deg,#1A237E,#303F9F,#1A237E,#4A148C);background-size:400% 400%;animation:gradMove 16s ease infinite;opacity:.15;z-index:-1}
    @keyframes gradMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    /* Smoother transforms on leaderboard items */
    .leaderboard-team{transform:translateZ(0)}

    /* --- Photo banner for group picture slide --- */
    .photo-banner{
      position: relative;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height:46vh;                /* take upper half of slide area visually */
      min-height:320px;
      border-radius:18px;
      padding:24px 28px;
      margin:0 auto 18px;
      background: linear-gradient(135deg,#0A0F2D 0%, #1A237E 35%, #303F9F 70%, #0A0F2D 100%);
      box-shadow: 0 12px 28px rgba(0,0,0,.22), inset 0 0 0 4px rgba(255,255,255,.05);
      color:#fff;
      text-align:center;
    }
    .photo-banner .pb-topline{
      font-family:'Inter',system-ui,sans-serif;
      text-transform:uppercase;
      letter-spacing:.22em;
      font-weight:800;
      font-size: clamp(14px, 1.4vw, 18px);
      opacity:.95;
    }
    .photo-banner .pb-title{
      font-family:'Poppins','Inter',sans-serif;
      font-weight:900;
      line-height:.9;
      text-transform:uppercase;
      margin-top:6px;
      font-size: clamp(38px, 5.6vw, 86px);
      -webkit-text-fill-color:#fff;
      -webkit-text-stroke: 3px rgba(10,15,45,.55);
      text-shadow: 0 4px 16px rgba(0,0,0,.35);
    }
    .photo-banner .pb-date{
      margin-top:10px;
      font-family:'Inter',system-ui,sans-serif;
      font-weight:800;
      font-size: clamp(16px, 1.6vw, 22px);
      letter-spacing:.08em;
      background: rgba(255,255,255,.12);
      border:2px solid rgba(255,255,255,.35);
      padding:8px 14px;
      border-radius:999px;
      box-shadow: 0 6px 16px rgba(0,0,0,.2);
    }
    /* helper: keep the bottom half visually clean for the crowd */
    .photo-note{
      font-size:18px; 
      color:#374151; 
      text-align:center; 
      opacity:.85; 
      margin-top:6px;
    }

    /* ===== FULL-BLEED PHOTO SLIDE (brand-forward) ===== */
    /* Hide side UI and expand slides to full-bleed during the photo slide */
    .photo-mode .fixed-header,
    .photo-mode .fixed-leaderboard,
    .photo-mode .fixed-footer,
    .photo-mode #q-hud { display: none !important; }
    .photo-mode .reveal { position: fixed; top: 0; bottom: 0; left: 0; right: 0; width: 100%; height: 100%; }

    /* Slide layout */
    section.photo-slide { padding: 0 !important; }
    .photo-stage{
      position: relative;
      height: 52vh;                /* upper half reserved for banner in photo */
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      margin: 0;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 12px 28px rgba(0,0,0,.22);
    }
    /* Brand background using ALI palette (navy, teal, gold) */
    .photo-bg{
      position: absolute; inset: 0;
      background:
        radial-gradient(1200px 60% at 50% -10%, rgba(255,179,0,.25), transparent 60%),
        radial-gradient(900px 50% at -10% 10%, rgba(26,35,126,.55), transparent 60%),
        radial-gradient(900px 50% at 110% 10%, rgba(0,121,107,.45), transparent 60%),
        linear-gradient(135deg, #0A0F2D 0%, #1A237E 45%, #00796B 100%);
      filter: none;
    }
    .photo-brand{ position: relative; z-index: 1; }
    .photo-kicker{
      font-family: 'Inter', system-ui, sans-serif;
      font-weight: 800;
      letter-spacing: .18em;
      text-transform: uppercase;
      font-size: clamp(14px, 1.4vw, 18px);
      color: #E0F2F1;
      opacity: .95;
    }
    .photo-title{
      font-family: 'Poppins','Inter',sans-serif;
      font-weight: 900;
      text-transform: uppercase;
      line-height: .9;
      margin-top: 6px;
      font-size: clamp(42px, 6.4vw, 110px);
      color: #FFFFFF;
      -webkit-text-stroke: 3px rgba(10,15,45,.50);
      text-shadow: 0 6px 24px rgba(0,0,0,.35);
    }
    .photo-date{
      margin-top: 14px;
      font-family: 'Inter',system-ui,sans-serif;
      font-weight: 900;
      letter-spacing: .08em;
      font-size: clamp(16px, 1.6vw, 24px);
      color: #231700;
      background: #FFB300;             /* gold pill */
      border: 3px solid #231700;
      padding: 8px 16px;
      border-radius: 999px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .photo-caption{
      margin: 22px auto 0;
      max-width: 980px;
      font-size: 22px;
      color: #374151;
      text-align: center;
    }

    /* --- Plain photo slide (no box, same background as other slides) --- */
    /* Keep controls visible in photo mode so navigation always works */
    .photo-mode .reveal .slide-number,
    .photo-mode .reveal .progress { display: none !important; }

    .photo-plain{
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding-top: 2vh;
      padding-left: 4vw;
      padding-right: 4vw;
      /* add generous bottom safe area so tagline never clips */
      padding-bottom: calc(16vh + env(safe-area-inset-bottom));
    }
    .photo-plain .photo-h1{
      font-family:'Inter',system-ui,sans-serif;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.12em;
      margin: 0;
      /* keep the full institute name on one line */
      white-space: nowrap;
      overflow-wrap: normal;
      /* slightly smaller than before to avoid wrapping */
      font-size: clamp(32px, 5vw, 84px);
      color: var(--navy);
      -webkit-text-stroke: 0;
      text-shadow: none;
    }
    .photo-plain .photo-h2{
      font-family:'Poppins','Inter',sans-serif;
      font-weight: 900;
      text-transform: none;
      line-height: .95;
      margin: 8px 0 0 0;
      font-size: clamp(34px,4.8vw,86px);
      color: #111;
    }
    .photo-plain .date{
      font-family:'Inter',system-ui,sans-serif;
      font-weight: 900;
      letter-spacing:.08em;
      margin-top: 10px;
      font-size: clamp(18px,1.8vw,28px);
      color: #374151;
    }
    .photo-plain .tagline{
      margin-top: auto;
      /* lift the tagline further from the bottom so it never gets cut off */
      margin-bottom: calc(14vh + env(safe-area-inset-bottom));
      text-align: center;
      max-width: 1100px;
      font-size: clamp(14px,1.6vw,20px);
      color: #374151;
    }
    .photo-plain .tagline a{ color: var(--navy); font-weight: 800; text-decoration: underline; }
    .qr-wrap{ 
      margin-top: 10px; 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      gap:6px; 
    }
    .qr-wrap canvas, 
    .qr-wrap img{ 
      width:140px; 
      height:140px; 
      image-rendering: pixelated; 
    }
    .qr-caption{
      font-size: 14px;
      color:#374151;
      font-weight:700;
    }
    /* KaTeX legibility + overflow */
    .katex-display { overflow-x: auto; overflow-y: hidden; padding-bottom: 4px; }
    .katex-display > .katex { white-space: nowrap; }
    .katex { font-size: 1em; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="fixed-header">
    <button id="hamburger" class="hamburger" aria-label="Open navigation" aria-haspopup="true" aria-expanded="false">☰</button>
    <div class="header-title">Middle School Math Bowl</div>
    <div class="header-info">Nov 16, 2025 • Active Learning Institute</div>
  </header>
  <div id="nav-backdrop" class="nav-backdrop" hidden></div>
  <nav id="nav-drawer" class="nav-drawer" aria-hidden="true">
    <header>Jump to Slide</header>
    <ul id="nav-list" class="nav-list"></ul>
  </nav>

  <!-- Leaderboard -->
  <aside class="fixed-leaderboard">
    <h3>Leaderboard</h3>
    <!-- NEW: Tense Mode button -->
    <button id="tense-toggle" title="Play tense beep & show BUZZ under the question">Tense: OFF</button>

    <button id="double-points-toggle">Double Points: OFF</button>
    <button id="reset-r1-btn" title="Zero all scores">Reset Scores</button>
    <button id="mode-individuals" title="Load Round 1 participants">R1: Individuals</button>
    <button id="mode-teams" title="Load Teams for Rounds 2/3">R2/3: Teams</button>
    <div id="leaderboard-container"></div>
  </aside>

  <!-- Slides -->
  <div class="reveal">
    <div class="slides">

      <!-- Title -->
      <section class="full-width animated-bg">
        <!-- PATCH 2: Use animated title class -->
        <h1 class="title-arcade" aria-label="Middle School Math Bowl">
          <span class="title-line">MIDDLE SCHOOL</span>
          <span class="title-line">MATH BOWL</span>
        </h1>
        <div class="chip-row" style="margin-top:8px;">
          <span class="chip lead">Student Lead: Vihari Battula</span>
          <span class="chip lead">Student Lead: Eshaan Vaduka</span>
        </div>
        <div class="chip-row" style="margin-top:6px;">
          <span class="mentor-chip">Mentored by Prof. Vinay Kanth Rao Kodipelly</span>
        </div>
        <p style="font-size:28px; margin-top:16px;">Buzzer Challenge</p>
        <p style="font-size:22px; margin-top:24px;">Welcome, teams! Get your buzzers ready.</p>
      </section>

      <!-- Rules -->
      <section>
        <h2>Competition Rules</h2>
        <ul>
          <li>First team to buzz gets to answer.</li>
          <li><strong>Correct Answer:</strong> +1000 points.</li>
          <li><strong>Incorrect Answer:</strong> -1000 points.</li>
          <li>Double Points may be activated (then ±2000).</li>
          <li>Leaderboard updates automatically.</li>
        </ul>
      </section>

      <!-- Round 1 intro -->
      <section class="animated-bg">
        <h1 style="font-size:52px; text-align:center;">Round 1</h1>
        <h2 style="font-size:64px; text-align:center; margin-top:20px;">the individual round</h2>
      </section>

      <!-- R1 problems -->
      <section>
        <h2>Problem 1: Arithmetic</h2>
        <p class="question-math">$3 + 6 \times (5 + 2) = ?$</p>
        <script type="text/x-solution">
          <h3 class="solution-title">Solution</h3>
          <div class="solution-body">$3 + 6\times(5+2)=3+6\times7=3+42=\boxed{45}$</div>
        </script>
      </section>

      <section>
        <h2>Problem 2: Pre-algebra</h2>
        <p class="question-math">A toy car rolls 2 meters in 1.25 seconds. If it continues for 5 more seconds at the same speed, how far will it travel?</p>
        <script type="text/x-solution">
          <h3 class="solution-title">Solution</h3>
          <div class="solution-body">Speed $=\tfrac{2}{1.25}=1.6\,\text{m/s}$. In $5$ s: $1.6\times5=\boxed{8\,\text{m}}$.</div>
        </script>
      </section>

      <section>
        <h2>Problem 3: Arithmetic</h2>
        <p class="question-math">A factory produces 150 toys every day. How many toys will it produce in 30 days?</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$150\times30=\boxed{4500}$ toys.</div></script>
      </section>

      <section>
        <h2 class="has-pill">Problem 4: Arithmetic <span class="dp-label">DOUBLE POINTS</span></h2>
        <p class="question-math">The sum of three consecutive even numbers is 528. What are the three numbers?</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">Let the even integers be $n,\,n+2,\,n+4$. Then $n+(n+2)+(n+4)=528\Rightarrow 3n+6=528\Rightarrow n=174$. Numbers: $\boxed{174,176,178}$.</div></script>
      </section>

      <section>
        <h2>Problem 5: Probability</h2>
        <p class="question-math">A bag has 4 red, 3 green, and 5 blue cards. What is the probability of <strong>not</strong> picking a red? Give a percentage (nearest whole number).</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">Total $12$; not red $=8$. $\tfrac{8}{12}=\tfrac{2}{3}\approx\boxed{67\%}$.</div></script>
      </section>

      <section>
        <h2>Problem 6: Linear Equation</h2>
        <p class="question-math">Solve: $\tfrac{1}{2}x + 3 = 7$</p>
        <script type="text/x-solution">
          <h3 class="solution-title">Solution</h3>
          <div class="solution-body">$\tfrac{1}{2}x + 3 = 7 \Rightarrow \tfrac{1}{2}x = 4 \Rightarrow x = \boxed{8}$. </div>
        </script>
      </section>

      <section>
        <h2>Problem 7: Pre-Algebra</h2>
        <p>Solve the inequality:</p>
        <p class="question-math">$5x - 3 \geq 2x + 9$</p>
        <p class="hint">Answer format: x ≥ … (e.g., x ≥ 5)</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$5x-3\ge 2x+9\Rightarrow 3x\ge12\Rightarrow \boxed{x\ge4}$.</div></script>
      </section>

      <section>
        <h2>Problem 8: Pre-Algebra</h2>
        <p class="question-math">The sum of three consecutive integers is 51. What are the integers?</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">Let the integers be $n,\,n+1,\,n+2$. Then $n+(n+1)+(n+2)=51\Rightarrow 3n+3=51\Rightarrow n=16$. Integers: $\boxed{16,17,18}$.</div></script>
      </section>

      <section>
        <h2>Problem 9: Geometry</h2>
        <p class="question-math">A right triangle has one leg 4 units and hypotenuse 5 units. Find the other leg.</p>
        <svg width="360" height="220" viewBox="0 0 360 220" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:10px auto">
          <polygon points="60,180 260,180 60,60" fill="#E3F2FD" stroke="#1A237E" stroke-width="3"/>
          <rect x="60" y="160" width="20" height="20" fill="#fff" stroke="#1A237E" stroke-width="2"/>
          <text x="30" y="120" font-family="Inter, sans-serif" font-size="16" fill="#1A237E" transform="rotate(-90,30,120)">4 units</text>
          <text x="150" y="195" font-family="Inter, sans-serif" font-size="16" fill="#1A237E">? units</text>
          <text x="150" y="110" font-family="Inter, sans-serif" font-size="16" fill="#1A237E">5 units</text>
          <line x1="60" y1="60" x2="260" y2="180" stroke="#1A237E" stroke-width="3"/>
        </svg>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">Other leg $=\sqrt{5^2-4^2}=\sqrt{25-16}=\boxed{3}$.</div></script>
      </section>

      <section>
        <h2>Problem 10: Geometry — Midpoint</h2>
        <p class="question-math">Find the midpoint of the segment with endpoints \((-2,\,5)\) and \((4,\,-1)\).</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$\Big(\tfrac{-2+4}{2},\tfrac{5+(-1)}{2}\Big)=(1,2)$. Answer: $\boxed{(1,2)}$.</div></script>
      </section>

      <!-- Round 1 end -->
      <section>
        <h1 style="font-size:82px; text-align:center;">ROUND ONE ENDS</h1>
      </section>

      <!-- Team pick -->
      <section>
        <h1 style="font-size:70px; text-align:center;">Winners Pick Teams</h1>
        <h2 style="font-size:50px; text-align:center;">1–4 positions pick teams</h2>
      </section>

      <!-- Round 2 intro -->
      <section class="animated-bg">
        <h1 style="font-size:70px; text-align:center;">Round Two Begins</h1>
      </section>

      <!-- R2 problems -->
      <section>
        <h2>Problem 1: Geometry</h2>
        <p class="question-math">A circle has <strong>diameter 10 cm</strong>. Find its area. (Leave in terms of $\pi$.)</p>
        <svg width="320" height="200" viewBox="0 0 320 200" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:10px auto">
          <circle cx="160" cy="100" r="70" fill="#E8F5E9" stroke="#1A237E" stroke-width="3"/>
          <line x1="90" y1="100" x2="230" y2="100" stroke="#1A237E" stroke-width="3"/>
          <text x="145" y="90" font-family="Inter, sans-serif" font-size="14" fill="#1A237E">10 cm</text>
        </svg>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$r=5$. Area $=\pi r^2=\boxed{25\pi\,\text{cm}^2}$.</div></script>
      </section>

      <section>
        <h2>Problem 2: Geometry</h2>
        <p class="question-math">A triangle has base <strong>12 cm</strong> and area <strong>48 cm²</strong>. Find the <em>height</em>.</p>
        <svg width="360" height="230" viewBox="0 0 360 230" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:10px auto">
          <polygon points="40,190 320,190 100,70" fill="#E3F2FD" stroke="#1A237E" stroke-width="3"/>
          <line x1="40" y1="190" x2="320" y2="190" stroke="#1A237E" stroke-width="3"/>
          <text x="165" y="210" font-family="Inter, sans-serif" font-size="16" fill="#1A237E">12 cm</text>
          <line x1="100" y1="70" x2="100" y2="190" stroke="#1A237E" stroke-width="2" stroke-dasharray="6,6"/>
          <rect x="100" y="170" width="18" height="18" fill="#fff" stroke="#1A237E" stroke-width="2"/>
          <text x="110" y="145" font-family="Inter, sans-serif" font-size="16" fill="#1A237E">h</text>
        </svg>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$\tfrac{1}{2}\cdot12\cdot h=48\Rightarrow h=\boxed{8\,\text{cm}}$.</div></script>
      </section>

      <section>
        <h2>Problem 3: Algebra — Slope</h2>
        <p class="question-math">Given $4y - 6x + 12 = 0$, write the equation in the form $y = mx + b$ and state the slope $m$.</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$4y=6x-12\Rightarrow y=\tfrac{3}{2}x-3$. Slope $m=\boxed{\tfrac{3}{2}}$.</div></script>
      </section>

      <section>
        <h2>Problem 4: Rate & Distance</h2>
        <p class="question-math">A cyclist travels at <strong>12.5 mph</strong> for <strong>1.6 hours</strong>. How far does the cyclist travel?</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$d=st=12.5\times1.6=\boxed{20\,\text{mi}}$.</div></script>
      </section>

      <section>
        <h2>Problem 5: Statistics</h2>
        <p class="question-math">Ages: 10, 12, 11, 13, 14. Find the mean.</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">Sum $=60$. Mean $=60/5=\boxed{12}$.</div></script>
      </section>

      <section>
        <h2>Problem 6: Systems of Equations (find x and y)</h2>
        <p class="question-math">Solve the system: $\begin{cases}2x + 3y = 19\\ 5x - 2y = 1\end{cases}$</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">Elimination gives $y=\tfrac{93}{19}$, $x=\tfrac{41}{19}$. $\boxed{\big(\tfrac{41}{19},\tfrac{93}{19}\big)}$.</div></script>
      </section>

      <section>
        <h2>Problem 7: Statistics</h2>
        <p>Find the median of: </p>
        <p class="question-math" style="font-size:24px; margin-top:20px;">6, 8, 10, 12, 14, 14, 16, 18, 18, 20</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">Median is average of 5th & 6th values: $(14+14)/2=\boxed{14}$.</div></script>
      </section>

      <section>
        <h2>Problem 8: Simplify</h2>
        <p class="question-math">Simplify: $\sqrt{9} + \sqrt{16} - \sqrt{25}$</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$3+4-5=\boxed{2}$.</div></script>
      </section>

      <section>
        <h2>Problem 9: Fractions — Simplify</h2>
        <p class="question-math">Simplify: $\dfrac{5}{8} + \dfrac{1}{4} + \dfrac{1}{8}$</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$\tfrac{5}{8}+\tfrac{2}{8}+\tfrac{1}{8}=\boxed{1}$.</div></script>
      </section>

      <section>
        <h2 class="has-pill">Problem 10: Pythagorean Theorem <span class="dp-label">DOUBLE POINTS</span></h2>
        <p class="question-math">A ladder touches a wall at 12 ft height; bottom is 5 ft from wall. (a) Length of ladder? (b) If top is at 9 ft, how far is the bottom from the wall? <em>(Round to the nearest hundredth.)</em></p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">(a) $\sqrt{12^2+5^2}=\sqrt{169}=\boxed{13\,\text{ft}}$. (b) Base $=\sqrt{13^2-9^2}=\sqrt{88}\approx\boxed{9.38\,\text{ft}}$.</div></script>
      </section>

      <section>
        <h2>Problem 11: Geometry</h2>
        <p class="question-math">A parallelogram has base $8\text{ cm}$ and height $6\text{ cm}$. Find its area. <em>Include exact units.</em></p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$A=bh=8\cdot6=\boxed{48\,\text{cm}^2}$.</div></script>
      </section>

      <section>
        <h2>Problem 12: Measurement</h2>
        <p class="question-math">A cube has side lengths of $4\text{ cm}$. Find its volume.</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$V=s^3=4^3=\boxed{64\,\text{cm}^3}$.</div></script>
      </section>

      <section>
        <h2>Problem 13: Probability</h2>
        <p class="question-math">A coin is flipped twice. What is the probability of getting two tails?</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$\Pr(TT)=(\tfrac12)^2=\boxed{\tfrac14=25\%}$.</div></script>
      </section>

      <section>
        <h2>Problem 14: Triangle Perimeter (Solve for x)</h2>
        <p class="question-math">The sides of a triangle are $x+2$, $x+3$, and $x+4$. If the perimeter is $36$, find $x$.</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$3x+9=36\Rightarrow x=\boxed{9}$. Sides: $11,12,13$.</div></script>
      </section>

      <section>
        <h2>Problem 15: Algebra — Expand</h2>
        <p class="question-math">Expand and simplify: $(2x - 3)(x + 5) - (x - 4)(x - 1)$</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$(2x-3)(x+5)=2x^2+7x-15$; $(x-4)(x-1)=x^2-5x+4$. Difference $=\boxed{x^2+12x-19}$.</div></script>
      </section>

      <!-- Difficult / swap section -->
      <section>
        <h1 style="font-size:52px; text-align:center;">DIFFICULT PROBLEMS</h1>
        <h2 style="font-size:64px; text-align:center; margin-top:20px;">SWAP QUESTIONS</h2>
      </section>

      <section>
        <h2>Challenge Question</h2>
        <p class="question-math">
          A bakery sells muffins in boxes of 6 at <span class="currency no-math">$7.80</span>/box and cupcakes in boxes of 8 at <span class="currency no-math">$10.40</span>/box.
          A customer buys 10 boxes total and spends <strong class="currency no-math">$88.40</strong>. How many muffin boxes and how many cupcake boxes?
        </p>
        <script type="text/x-solution">
          <h3 class="solution-title">Solution</h3>
          <div class="solution-body">Let muffins $m$, cupcakes $c$. $m+c=10$, $7.80m+10.40c=88.40$. Multiply by 10, divide by 2: $39m+52c=442$. With $m=10-c$: $390+13c=442\Rightarrow c=4$, $m=6$. Answer: $\boxed{6\text{ muffins},\ 4\text{ cupcakes}}$.</div>
        </script>
      </section>

      <section>
        <h2 class="question-math">Challenge Question</h2>
        <p class="question-math">Solve the system: <strong>2x + 3y = 12</strong>, <strong>4x - y = 5</strong>.</p>
        <script type="text/x-solution">
          <h3 class="solution-title">Solution</h3>
          <div class="solution-body">From $4x-y=5\Rightarrow y=4x-5$. Substitute: $2x+3(4x-5)=12\Rightarrow 14x=27\Rightarrow x=\tfrac{27}{14}$, $y=\tfrac{19}{7}$. $\boxed{(\tfrac{27}{14},\tfrac{19}{7})}$.</div>
        </script>
      </section>

      <!-- Final Round -->
      <section class="animated-bg">
        <h1 style="font-size:64px; text-align:center; margin-top:20px;">THE FINAL ROUND</h1>
      </section>

      <section>
        <h2 class="question-math">Problem 1: Linear Equation – Multi-step</h2>
        <p class="question-math">Solve: <strong>3(2x - 4) - 5 = 2(x + 7)</strong></p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$6x-12-5=2x+14\Rightarrow 4x=31\Rightarrow x=\boxed{\tfrac{31}{4}}\,(=7.75)$.</div></script>
      </section>

      <section>
        <h2>Problem 2: Linear Word Problem — Tickets</h2>
        <p class="question-math">A theater sells adult tickets for <span class="currency no-math">$8</span> and child tickets for <span class="currency no-math">$5</span>. If <strong>120</strong> tickets are sold for <span class="currency no-math">$840</span> total, how many adult and child tickets?</p>
        <script type="text/x-solution">
          <h3 class="solution-title">Solution</h3>
          <div class="solution-body">Let $a$ and $c$ be the number of adult and child tickets. $a+c=120$, $8a+5c=840$. Then $8a+5(120-a)=840\Rightarrow 3a=240\Rightarrow a=\boxed{80}$ and $c=\boxed{40}$.</div>
        </script>
      </section>

      <section>
        <h2>Problem 4: Algebraic Reasoning</h2>
        <p class="question-math">If <strong>2x + 3 = 7</strong>, find <strong>4x + 6</strong>.</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$4x+6=2(2x+3)=2\cdot7=\boxed{14}$.</div></script>
      </section>

      <section>
        <h2>Problem 5: Linear Equation with Fractions</h2>
        <p class="question-math">Solve: $\dfrac{2x-3}{4} = \dfrac{x+5}{3}$</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$3(2x-3)=4(x+5)\Rightarrow 6x-9=4x+20\Rightarrow 2x=29\Rightarrow x=\boxed{\tfrac{29}{2}}\,(=14.5)$.</div></script>
      </section>

      <section>
        <h2>Problem 6: Simplify – Distributive & Combine</h2>
        <p class="question-math"><strong>2(3x² - 4x + 5) - (x² - 6x - 2)</strong></p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$2(3x^2-4x+5)-(x^2-6x-2)=\boxed{5x^2-2x+12}$.</div></script>
      </section>

      <section>
        <h2>Problem 7: Absolute Value (solve for x-values only)</h2>
        <p class="question-math">Solve: <strong>|3x - 7| = 5</strong></p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$3x-7=5\Rightarrow x=4$ or $3x-7=-5\Rightarrow x=\tfrac{2}{3}$. $\boxed{x\in\{4,\tfrac{2}{3}\}}$.</div></script>
      </section>

      <section>
        <h2>Problem 8: Substitution</h2>
        <p class="question-math">If <strong>a = 2b + 1</strong> and <strong>b = 3</strong>, find <strong>4a - 5b</strong>.</p>
        <script type="text/x-solution"><h3 class="solution-title">Solution</h3><div class="solution-body">$a=7$, so $4a-5b=28-15=\boxed{13}$.</div></script>
      </section>

      <section>
        <h2>Problem 9: Evaluate the Expression</h2>
        <p class="question-math">Evaluate: $\sqrt[3]{512} - 8^2$ <span class="hint">(Hint: $512$ is a perfect cube.)</span></p>
        <script type="text/x-solution">
          <h3 class="solution-title">Solution</h3>
          <div class="solution-body">$\sqrt[3]{512}=8$ and $8^2=64$, so the value is $8-64=\boxed{-56}$.</div>
        </script>
      </section>

      <section>
        <h2 class="question-math">Problem 10: Final Challenge — Pool Filling</h2>
        <p class="question-math">A rectangular pool is <strong>50 ft</strong> long and <strong>30 ft</strong> wide. It is being filled at <strong>\(50\,\text{ft}^3/\text{min}\)</strong>. If the pool is <strong>10 ft</strong> deep, how long will it take to fill the pool completely, in <em>hours</em>?</p>
        <script type="text/x-solution">
          <h3 class="solution-title">Solution</h3>
          <div class="solution-body">
            Volume \(V=\ell\,w\,h=50\cdot30\cdot10=15000\,\text{ft}^3\).<br/>
            Fill rate \(r=50\,\text{ft}^3/\text{min}\).<br/>
            Time in minutes \(t=V/r=15000/50=300\) minutes.<br/>
            Convert to hours: \(300/60=\boxed{5\ \text{hours}}\).
          </div>
        </script>
      </section>

      <section>
        <h1>COMPETITION over</h1>
        <p>This marks the conclusion of the math bowl</p>
      </section>

      <!-- Group Photo + Branding (FULL BLEED) -->
      <section class="photo-slide" data-photo-slide="1">
        <div class="photo-plain" aria-label="Group photo banner text">
          <h1 class="photo-h1">ACTIVE LEARNING INSTITUTE</h1>
          <h2 class="photo-h2">Middle School Math Bowl</h2>
          <div class="date">16 November 2025</div>
          <div class="tagline">
            Empowering students &amp; teachers with hands-on STEM learning, from India to St. Louis since 2018.
            <br>
            For more about our works visit: <a href="https://www.activestem.org" target="_blank" rel="noopener">www.activestem.org</a>
          </div>
          <div class="qr-wrap" aria-label="QR code for activestem.org">
            <div id="qr-activestem"></div>
            <div class="qr-caption">Scan to visit activestem.org</div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Participant High-Octane HUD (chips + progress only) -->
  <div id="q-hud" class="qhud" aria-hidden="true">
    <div class="qh-bottom">
      <!-- PATCH 3: This element is no longer written to by JS, but kept for layout -->
      <div id="qh-current" class="qh-current" style="visibility: hidden;"></div>
      <div class="qh-progress"><div id="qh-progress-bar"></div></div>
    </div>
  </div>


  <!-- Footer -->
  <footer class="fixed-footer">
    ©️ 2025 Active Learning Institute <a href="https://www.activestem.org" target="_blank">www.activestem.org</a>
  </footer>

  <!-- JS: reveal -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.6.1/reveal.min.js"></script>

  <!-- KaTeX JS + auto-render -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <!-- QR code generator (client-side; no image fetch) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // --- KaTeX auto-render config ---
    const KATEX_DELIMITERS = [
      { left: "$$", right: "$$", display: true },
      { left: "$",  right: "$",  display: false },
      { left: "\\(", right: "\\)", display: false },
      { left: "\\[", right: "\\]", display: true }
    ];
    function renderAllMath(root){
      const target = root || document.querySelector('.reveal');
      if (!target) return;

      // Protect currency like $7.80, $1,200.50, $10/box from KaTeX by wrapping in spans with class no-math
      (function protectCurrency(node){
        const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null);
        const textNodes = [];
        while (walker.nextNode()) textNodes.push(walker.currentNode);

        // Match $ amounts like $7.80, $1,200.50, $10/box — but **NOT** math like $5x, $8^2, or $8\text{cm}
        const re = /\$(\d{1,3}(?:,\d{3})*(?:\.\d+)?|\d+(?:\.\d+)?)(?=$|\s|[,.;:!?%\/\)\]])/g;

        textNodes.forEach(txt => {
          // Skip if this text node already sits inside a protected no-math span
          if (txt.parentNode && txt.parentNode.nodeType === 1 && txt.parentNode.classList && txt.parentNode.classList.contains('no-math')) return;
          // Skip nodes inside math/solution blocks so we don't mistake $3 in $3+2$
          if (txt.parentElement && txt.parentElement.closest('.question-math, .question-math-smaller, .solution-body, .katex')) {
            return;
          }

          const s = txt.nodeValue;
          if (!re.test(s)) return; // no currency-like pattern
          re.lastIndex = 0;

          const frag = document.createDocumentFragment();
          let i = 0, m;
          while ((m = re.exec(s))) {
            if (m.index > i) frag.appendChild(document.createTextNode(s.slice(i, m.index)));
            const span = document.createElement('span');
            span.className = 'currency no-math';
            span.textContent = '$' + m[1];
            frag.appendChild(span);
            i = m.index + m[0].length;
          }
          if (i < s.length) frag.appendChild(document.createTextNode(s.slice(i)));
          if (txt.parentNode) txt.parentNode.replaceChild(frag, txt);
        });
      })(target);

      if (window.renderMathInElement){
        renderMathInElement(target, {
          delimiters: KATEX_DELIMITERS,
          throwOnError: false,
          strict: false,
          ignoredClasses: ['no-math']
        });
      }
    }

    // === Photo Slide helpers ===
    function isPhotoSlide(sec){ return !!(sec && sec.dataset && sec.dataset.photoSlide === '1'); }
    function applyPhotoMode(active){ document.body.classList.toggle('photo-mode', !!active); }

    // --- Leaderboard state ---
    let isDoublePoints = false;
    let isTeamMode = true; // teams by default for R2/3

    // Selection, undo, storage
    let selectedEntryId = null;
    const undoStack = [];

    const STORAGE_KEYS = {
      teams: 'msmb_teams',
      participants: 'msmb_participants'
    };

    // HUD metadata
    let roundIndexMap = new Map();

    // Confetti + audio (micro)
    let audioCtx = null;
    function ensureAudio(){ try{ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } if (audioCtx.state === 'suspended'){ audioCtx.resume(); } }catch(e){} }
    function bip(freq=880, ms=140){
      if(!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type='triangle'; osc.frequency.value=freq;
      gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+ms/1000);
      osc.connect(gain).connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+ms/1000);
    }
    function sfxGood(){ ensureAudio(); bip(1046,100); setTimeout(()=>bip(1318,100),110); setTimeout(()=>bip(1568,120),220); }
    function sfxBad(){ ensureAudio(); bip(220,180); setTimeout(()=>bip(196,160),170); setTimeout(()=>bip(165,200),330); }
    function flash(kind){
      const el = document.getElementById(kind==='good'?'fb-good':'fb-bad');
      if(!el) return;
      el.style.display='block';
      requestAnimationFrame(()=>{ el.style.opacity='1'; });
      setTimeout(()=>{
        el.style.opacity='0';
        setTimeout(()=>{ el.style.display='none'; }, 140);
      }, 420);
    }
    function showBuzzLock(name){ /* overlay removed */ }

    function fireConfetti(duration=1200){
      const cv = document.getElementById('confetti-canvas');
      const ctx = cv.getContext('2d');
      cv.style.display='block';
      const rect = cv.getBoundingClientRect();
      cv.width = rect.width * devicePixelRatio;
      cv.height = rect.height * devicePixelRatio;
      const N = 120, parts=[];
      for(let i=0;i<N;i++){
        parts.push({
          x: Math.random()*cv.width,
          y: -Math.random()*cv.height*0.3,
          vx: (Math.random()-0.5)*4,
          vy: Math.random()*3+2,
          w: Math.random()*6+2,
          h: Math.random()*12+6,
          rot: Math.random()*Math.PI,
          vr: (Math.random()-0.5)*0.2
        });
      }
      let start = performance.now();
      function step(t){
        const dt = 16;
        ctx.clearRect(0,0,cv.width,cv.height);
        parts.forEach(p=>{
          p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
          ctx.fillStyle = ['#4CAF50','#1A237E','#FFB300','#E91E63'][Math.floor(Math.random()*4)];
          ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
          ctx.restore();
        });
        if (t-start < duration) requestAnimationFrame(step); else cv.style.display='none';
      }
      requestAnimationFrame(step);
    }

    // === TENSE MODE (music + inline BUZZ pill) ===
    let tenseMode = false;
    let tenseInterval = null;

    function addBuzzPillForSection(sec){
      // Remove any existing pills first
      document.querySelectorAll('.buzz-pill').forEach(el=>el.remove());
      if (!sec || !isProblemSlide(sec)) return;
      const actions = sec.querySelector('.flash-actions') || sec;
      const pill = document.createElement('div');
      pill.className = 'buzz-pill';
      pill.textContent = 'BUZZ NOW!';
      actions.appendChild(pill);
    }
    function clearBuzzPills(){
      document.querySelectorAll('.buzz-pill').forEach(el=>el.remove());
    }
    function startTenseTrack(){
      ensureAudio();
      stopTenseTrack();
      const start = Date.now();
      function beat(){
        const elapsed = Date.now()-start;
        const base = 900, min = 450; // speeds up over ~30s
        const interval = Math.max(min, base - (elapsed/30000)*(base - min));
        bip(200,100);
        setTimeout(()=>bip(200,100),120);
        tenseInterval = setTimeout(beat, interval);
      }
      beat();
    }
    function stopTenseTrack(){
      if (tenseInterval){ clearTimeout(tenseInterval); tenseInterval=null; }
    }
    function toggleTenseMode(){
      tenseMode = !tenseMode;
      const btn = document.getElementById('tense-toggle');
      if (tenseMode){
        btn.classList.add('active'); btn.textContent='Tense: ON';
        startTenseTrack();
        addBuzzPillForSection(Reveal.getCurrentSlide());
      }else{
        btn.classList.remove('active'); btn.textContent='Tense: OFF';
        stopTenseTrack();
        clearBuzzPills();
      }
    }

    const teamsTemplate = [
      { id: 't1', name: 'Team Alpha', score: 0 },
      { id: 't2', name: 'Team Bravo', score: 0 },
      { id: 't3', name: 'Team Charlie', score: 0 },
      { id: 't4', name: 'Team Delta', score: 0 },
      // PATCH 5: Add 5th team
      { id: 't5', name: 'Team Echo', score: 0 }
    ];

    // Round 1 individuals
    const participantsTemplate = [
      { id: 'p1',  name: 'Aarush', score: 0 },
      { id: 'p2',  name: 'Sukriti Chintalacheruvu', score: 0 },
      { id: 'p3',  name: 'Aadhya Mamidi', score: 0 },
      { id: 'p4',  name: 'Aniketh', score: 0 },
      { id: 'p5',  name: 'Shivasai Thatikonda', score: 0 },
      { id: 'p6',  name: 'Jeevesh Bhaskar', score: 0 },
      { id: 'p7',  name: 'Krivik', score: 0 },
      { id: 'p8',  name: 'Pooshna Manchala', score: 0 },
      { id: 'p9',  name: 'Rohan Narhe', score: 0 },
      { id: 'p10', name: 'Aadyashakti', score: 0 },
      { id: 'p11', name: 'Varnika Vinjam', score: 0 },
      { id: 'p12', name: 'Dhruv Bherthepudi', score: 0 },
      { id: 'p13', name: 'Vivek pulkurtikar', score: 0 },
      { id: 'p14', name: 'Gautham Jayaprakash', score: 0 },
      { id: 'p15', name: 'Vihaan V', score: 0 },
      { id: 'p16', name: 'Divij Bishnoi', score: 0 },
      { id: 'p17', name: 'Rishi Linga', score: 0 },
      { id: 'p18', name: 'Amaira Hasija', score: 0 },
      { id: 'p19', name: 'Sethu Bayya', score: 0 },
      { id: 'p20', name: 'Plaksha pratihar', score: 0 },
      // PATCH 6: Add new participant
      { id: 'p21', name: 'Saanvi Vitthala', score: 0 }
    ];

    // Current scoreboard entries (cloned from template on mode switch)
    let teams = JSON.parse(JSON.stringify(teamsTemplate));

    function initializeLeaderboard(){
      const container = document.getElementById('leaderboard-container');
      container.innerHTML = '';
      teams.forEach(team => {
        const teamEl = document.createElement('div');
        teamEl.className = 'leaderboard-team';
        teamEl.id = `leaderboard-team-${team.id}`;
        teamEl.setAttribute('data-id', team.id);
        const swapBtn = isTeamMode ? `<button class="swap" onclick="swapWithLeader('${team.id}')">SWAP TOP</button>` : '';
        teamEl.innerHTML = `
          <div class="team-rank"></div>
          <div class="team-info">${team.name}</div>
          <div class="team-score"></div>
          <div class="score-buttons">
            <button class="add" onclick="updateScore('${team.id}', 1000)">+1000</button>
            <button class="sub" onclick="updateScore('${team.id}', -1000)">-1000</button>
            ${swapBtn}
          </div>
        `;
        teamEl.addEventListener('click', ()=> selectEntryById(team.id));
        container.appendChild(teamEl);
      });
    }

    function setMode(mode){
      if (mode === 'individuals'){
        isTeamMode = false;
        teams = JSON.parse(JSON.stringify(participantsTemplate));
        const saved = localStorage.getItem(STORAGE_KEYS.participants);
        if (saved){ try{
          const arr = JSON.parse(saved);
          teams.forEach(t=>{ const s=arr.find(a=>a.id===t.id); if(s) t.score=s.score; });
        }catch(e){} }
      } else {
        isTeamMode = true;
        teams = JSON.parse(JSON.stringify(teamsTemplate));
        const saved = localStorage.getItem(STORAGE_KEYS.teams);
        if (saved){ try{
          const arr = JSON.parse(saved);
          teams.forEach(t=>{ const s=arr.find(a=>a.id===t.id); if(s) t.score=s.score; });
        }catch(e){} }
      }
      selectedEntryId = null;
      initializeLeaderboard();
      renderLeaderboard();
      refreshHudSelection();
    }

    function cloneResetCurrent(){
      teams.forEach(t => t.score = 0);
    }

    function updateScore(teamId, basePoints){
      const points = isDoublePoints ? basePoints * 2 : basePoints;
      const team = teams.find(t => t.id === teamId);
      if (!team) return;
      undoStack.push({ id: teamId, delta: points });
      team.score += points;
      // No overlay/toast on scoring; just update the board.
      renderLeaderboard();
      refreshHudSelection();
    }

    function swapWithLeader(teamId){
      const leader = [...teams].sort((a,b)=>b.score-a.score)[0];
      const me = teams.find(t => t.id === teamId);
      if (!leader || !me || leader.id === me.id) return;
      const tmp = me.score; me.score = leader.score; leader.score = tmp;
      renderLeaderboard();
    }

    function toggleDoublePoints(){
      isDoublePoints = !isDoublePoints;
      const toggleBtn = document.getElementById('double-points-toggle');
      const addButtons = document.querySelectorAll('.score-buttons .add');
      const subButtons = document.querySelectorAll('.score-buttons .sub');
      if (isDoublePoints){
        toggleBtn.textContent = 'Double Points: ON';
        toggleBtn.classList.add('active');
        addButtons.forEach(btn => btn.textContent = '+2000');
        subButtons.forEach(btn => btn.textContent = '-2000');
      } else {
        toggleBtn.textContent = 'Double Points: OFF';
        toggleBtn.classList.remove('active');
        addButtons.forEach(btn => btn.textContent = '+1000');
        subButtons.forEach(btn => btn.textContent = '-1000');
      }
      
      // PATCH 3: This line was removed, but we still need to update the DP banner logic
      // hudSetText('qh-points', isDoublePoints?'+2000 / -2000':'+1000 / -1000');
      
      const sec = Reveal.getCurrentSlide();
      if (sec){
        let b = sec.querySelector('.dp-banner');
        if (!b){ b = document.createElement('div'); b.className='dp-banner'; b.textContent='DOUBLE POINTS'; sec.appendChild(b); }
        b.style.display = isDoublePoints && isProblemSlide(sec) ? 'block' : 'none';
      }
    }

    function resetLeaderboard(){
      cloneResetCurrent();
      if (isDoublePoints){
        isDoublePoints = false;
        const toggleBtn = document.getElementById('double-points-toggle');
        toggleBtn.textContent = 'Double Points: OFF';
        toggleBtn.classList.remove('active');
        document.querySelectorAll('.score-buttons .add').forEach(btn => btn.textContent = '+1000');
        document.querySelectorAll('.score-buttons .sub').forEach(btn => btn.textContent = '-1000');
      }
      renderLeaderboard();
    }

    function renderLeaderboard(){
      const firstPos = {};
      teams.forEach(t=>{
        const el = document.getElementById('leaderboard-team-'+t.id);
        if(el) firstPos[t.id] = el.getBoundingClientRect();
      });

      teams.sort((a,b)=>b.score-a.score);

      teams.forEach((t,i)=>{
        const el = document.getElementById('leaderboard-team-'+t.id);
        if(!el) return;
        el.querySelector('.team-rank').textContent = i+1;
        const scoreEl = el.querySelector('.team-score');
        const prev = Number((scoreEl.textContent||'0').replace(/[^\d-]/g,''))||0;
        if (prev != t.score){ animateCount(scoreEl, prev, t.score, 550); } else { scoreEl.textContent = t.score + ' pts'; }
        el.style.order = i;
        el.classList.remove('rank-1','rank-2','rank-3','selected');
        if (i===0) el.classList.add('rank-1'); else if (i===1) el.classList.add('rank-2'); else if (i===2) el.classList.add('rank-3');
        if (selectedEntryId === t.id) el.classList.add('selected');
      });

      teams.forEach(t=>{
        const el = document.getElementById('leaderboard-team-'+t.id);
        const last = el && el.getBoundingClientRect();
        const first = firstPos[t.id];
        if(!el || !first || !last) return;
        const dx = first.left - last.left;
        const dy = first.top - last.top;
        if (Math.abs(dx) || Math.abs(dy)){
          el.style.transition = 'none';
          el.style.transform = 'translate('+dx+'px,'+dy+'px)';
          el.getBoundingClientRect();
          el.style.transition = 'transform .5s ease-out';
          el.style.transform = 'translate(0,0)';
          setTimeout(()=>{ el.style.transition=''; }, 520);
        }
      });

      const key = isTeamMode ? STORAGE_KEYS.teams : STORAGE_KEYS.participants;
      try { localStorage.setItem(key, JSON.stringify(teams)); } catch(e){}
    }
    function animateCount(node, from, to, ms=550){
      const start = performance.now();
      function step(t){
        const p = Math.min(1, (t-start)/ms);
        const val = Math.round(from + (to - from) * p);
        node.textContent = val + ' pts';
        if (p < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    function selectEntryById(id){
      selectedEntryId = id;
      const t = teams.find(x=>x.id===id); // overlay removed (no buzz lock)
      document.querySelectorAll('.leaderboard-team').forEach(el=>{
        el.classList.toggle('selected', el.getAttribute('data-id')===id);
      });
      refreshHudSelection();
    }
    function selectNext(delta){
      if (!teams.length) return;
      let idx = teams.findIndex(t=>t.id===selectedEntryId);
      if (idx<0) idx = 0;
      idx = (idx + delta + teams.length) % teams.length;
      selectEntryById(teams[idx].id);
    }

    function undoLast(){
      const last = undoStack.pop(); if(!last) return;
      const t = teams.find(x=>x.id===last.id); if(!t) return;
      t.score -= last.delta; renderLeaderboard();
    }

    function exportCSV(){
      const rows = [['Rank','Name','Score']].concat(teams.map((t,i)=>[String(i+1), t.name, String(t.score)]));
      const csv = rows.map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = isTeamMode ? 'teams_scores.csv' : 'individual_scores.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // === Round tagging and HUD utilities ===
    function tagRoundsAndQuestions(){
      const secs = Array.from(document.querySelectorAll('.reveal .slides section'));
      let phase = 'R0';
      let count = 0; let totals = {R1:0, R2:0, RF:0};
      secs.forEach(sec=>{
        const h1 = (sec.querySelector('h1')||{}).textContent||'';
        if (/round\s*1/i.test(h1)) { phase='R1'; count=0; }
        if (/round\s*one\s*ends/i.test(h1)) { phase='R0'; }
        if (/round\s*two\s*begins/i.test(h1)) { phase='R2'; count=0; }
        if (/final\s*round/i.test(h1) || /difficult\s*problems/i.test(h1)) { phase='RF'; count=0; }
        if (isProblemSlide(sec)){
          count++; totals[phase] = (totals[phase]||0)+1;
          roundIndexMap.set(sec, {phase, qn: count});
        }
      });
      secs.forEach(sec=>{
        if (roundIndexMap.has(sec)){
          const meta = roundIndexMap.get(sec);
          meta.qnOf = totals[meta.phase]||0;
          roundIndexMap.set(sec, meta);
        }
      });
    }
    function hudSetText(id, text){ const el = document.getElementById(id); if (el) el.textContent = text; }
    function hudToast(){ /* overlay removed per host request */ }
    function currentCategoryFromSlide(sec){
      const h2 = sec.querySelector('h2'); if(!h2) return '—';
      const t = h2.textContent;
      const m = t.match(/:\s*([^—\-\:]+)/);
      if (m && m[1]) return m[1].trim();
      const m2 = t.match(/—\s*([^:]+)/);
      return (m2 && m2[1]) ? m2[1].trim() : t.replace(/Problem\s*\d+\s*:?/i,'').trim();
    }
    function difficultyFromPhase(ph){ return ph==='R1'?'Easy':(ph==='R2'?'Medium':'Difficult'); }
    
    // PATCH 3: Remove hudSetText calls for round, category, and points
    function updateHudForSlide(sec){
      const hud = document.getElementById('q-hud'); if(!hud) return;
      const meta = roundIndexMap.get(sec) || {phase:'', qn:'', qnOf:''};
      
      const pct = (meta.qn && meta.qnOf) ? Math.min(100, Math.max(0, (meta.qn/meta.qnOf)*100)) : 0;
      const bar = document.getElementById('qh-progress-bar'); if(bar) bar.style.width = pct+'%';
      
      hud.style.display = isProblemSlide(sec) ? 'block' : 'none';
      refreshHudSelection();
      
      if (tenseMode){ addBuzzPillForSection(sec); }
      
      if (isProblemSlide(sec)){
        let b = sec.querySelector('.dp-banner');
        if (!b){ b = document.createElement('div'); b.className = 'dp-banner'; b.textContent = 'DOUBLE POINTS'; sec.appendChild(b); }
        b.style.display = isDoublePoints ? 'block' : 'none';
      }
    }
    
    // PATCH 3: Replace refreshHudSelection to remove the prompt
    function refreshHudSelection(){
      const el = document.getElementById('qh-current');
      if (el) el.textContent = ''; // no participant-facing prompt
    }

    // --- Flashcard helpers ---
    function isProblemSlide(section){
      if (!section) return false;
      // Skip known non-problem title slides first
      const h1 = section.querySelector('h1');
      if (h1){
        const t1 = h1.textContent.toLowerCase();
        const skip = ['round','winner','final','competition over','difficult problems','swap questions','rules','leaderboard','middle school math bowl'];
        if (skip.some(s => t1.includes(s))) return false;
      }
      // Detect actual problems
      if (section.querySelector('script[type="text/x-solution"]')) return true;
      if (section.querySelector('.question-math, .question-math-smaller')) return true;
      const h2 = section.querySelector('h2');
      if (h2 && /problem\s*\d+/i.test(h2.textContent)) return true;
      return false;
    }

    function setupFlashcards(){
      const sections = document.querySelectorAll('.reveal .slides section');

      sections.forEach((sec) => {
        if (sec.dataset.flashcard === '1') return;
        if (!isProblemSlide(sec)) return;

        let providedSolution = '';
        const solScript = sec.querySelector('script[type="text/x-solution"]');
        if (solScript) { providedSolution = solScript.innerHTML; solScript.remove(); }

        const originalHTML = sec.innerHTML;

        const front = document.createElement('div');
        front.className = 'flash-face flash-front';
        front.innerHTML = originalHTML;

        const back = document.createElement('div');
        back.className = 'flash-face flash-back';
        back.innerHTML = (providedSolution && providedSolution.trim().length > 0)
          ? providedSolution
          : '<h3 class="solution-title">Answer / Solution</h3><div class="solution-body">Instructor note: add the worked solution for this question here.</div>';

        const card = document.createElement('div');
        card.className = 'flashcard';
        card.appendChild(front);
        card.appendChild(back);

        const wrap = document.createElement('div');
        wrap.className = 'flashcard-wrap';
        wrap.appendChild(card);

        const actions = document.createElement('div');
        actions.className = 'flash-actions';
        const btnReveal = document.createElement('button');
        btnReveal.className = 'reveal-btn';
        btnReveal.textContent = 'Reveal Answer';
        const btnBack = document.createElement('button');
        btnBack.className = 'back-btn';
        btnBack.textContent = 'Back to Question';
        actions.appendChild(btnReveal);
        actions.appendChild(btnBack);

        btnReveal.style.display = 'inline-block';
        btnBack.style.display = 'none';

        sec.innerHTML = '';
        sec.appendChild(wrap);
        sec.appendChild(actions);
        sec.dataset.flashcard = '1';

        // Note: Delegated click handlers are now used, so individual listeners are removed.
      });
      
      // PATCH 9: Render math after injecting new nodes
      renderAllMath(); // parse new nodes we just injected
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('double-points-toggle').addEventListener('click', toggleDoublePoints);
      document.getElementById('reset-r1-btn').addEventListener('click', resetLeaderboard);
      const btnInd = document.getElementById('mode-individuals');
      const btnTeams = document.getElementById('mode-teams');
      if (btnInd) btnInd.addEventListener('click', () => setMode('individuals'));
      if (btnTeams) btnTeams.addEventListener('click', () => setMode('teams'));

      const tenseBtn = document.getElementById('tense-toggle');
      if (tenseBtn) tenseBtn.addEventListener('click', toggleTenseMode);

      // Tag rounds for progress and metadata
      tagRoundsAndQuestions();

      // start in Teams mode for R2/3 by default
      setMode('teams');

      // Build flashcards, then render KaTeX (so both faces get parsed)
      setupFlashcards();
      // renderAllMath(); // This call is now inside setupFlashcards

      // Delegated handlers for flashcard buttons (PATCH 4: Kept as-is)
      document.addEventListener('click', function(evt){
        const revealBtn = evt.target.closest('.reveal-btn');
        if (revealBtn){
          const sec = revealBtn.closest('section');
          const card = sec && sec.querySelector('.flashcard');
          const backBtn = sec && sec.querySelector('.back-btn');
          if (card) card.classList.add('flipped');
          if (revealBtn) revealBtn.style.display='none';
          if (backBtn) backBtn.style.display='inline-block';
          renderAllMath(sec); // Re-render KaTeX on flip to back
          return;
        }
        const backBtn = evt.target.closest('.back-btn');
        if (backBtn){
          const sec = backBtn.closest('section');
          const card = sec && sec.querySelector('.flashcard');
          const revBtn = sec && sec.querySelector('.reveal-btn');
          if (card) card.classList.remove('flipped');
          if (backBtn) backBtn.style.display='none';
          if (revBtn) revBtn.style.display='inline-block';
        }
      }, true); // Use capture phase for reliability

      Reveal.initialize({ hash: true });
      /* Build hamburger navigation */
      function buildNavMenu(){
        const ul = document.getElementById('nav-list'); if(!ul) return;
        ul.innerHTML = '';
        const secs = Array.from(document.querySelectorAll('.reveal .slides > section'));
        secs.forEach((sec, idx) => {
          const titleEl = sec.querySelector('h1, h2');
          const text = (titleEl ? titleEl.textContent.trim() : `Slide ${idx+1}`) || `Slide ${idx+1}`;
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = `#/${idx}`;
          a.textContent = text.length > 80 ? text.slice(0,77)+'…' : text;
          a.addEventListener('click', (e)=>{ e.preventDefault(); closeNav(); window.location.hash = `#/${idx}`; });
          li.appendChild(a); ul.appendChild(li);
        });
      }
      buildNavMenu(); // populate immediately in case 'ready' already fired
      Reveal.on('ready', buildNavMenu);
      Reveal.on('slidechanged', buildNavMenu); // keep list in sync

      /* Hamburger open/close */
      const hb = document.getElementById('hamburger');
      const drawer = document.getElementById('nav-drawer');
      const backdrop = document.getElementById('nav-backdrop');
      function openNav(){ drawer.classList.add('open'); backdrop.classList.add('open'); backdrop.hidden = false; hb && hb.setAttribute('aria-expanded','true'); drawer.setAttribute('aria-hidden','false'); }
      function closeNav(){ drawer.classList.remove('open'); backdrop.classList.remove('open'); backdrop.hidden = true; hb && hb.setAttribute('aria-expanded','false'); drawer.setAttribute('aria-hidden','true'); }
      if (hb){ hb.addEventListener('click', ()=> drawer.classList.contains('open') ? closeNav() : openNav()); }
      if (backdrop){ backdrop.addEventListener('click', closeNav); }
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeNav(); if (e.key==='m' || e.key==='M') (drawer.classList.contains('open')?closeNav():openNav()); });

      /* Generate QR (blue on white) */
      const qrTarget = document.getElementById('qr-activestem');
      if (qrTarget && window.QRCode){
        new QRCode(qrTarget, {
          text: 'https://www.activestem.org',
          width: 140, height: 140,
          colorDark: '#1A237E', colorLight: '#FFFFFF',
          correctLevel: QRCode.CorrectLevel.M
        });
      }

      // Apply photo mode if we start on the photo slide
      applyPhotoMode(isPhotoSlide(Reveal.getCurrentSlide()));

      // Initial HUD + re-render math on slide change
      updateHudForSlide(Reveal.getCurrentSlide());
      
      // PATCH 4: Add guard to existing slidechanged listener
      Reveal.on('slidechanged', e => {
        applyPhotoMode(isPhotoSlide(e.currentSlide));
        updateHudForSlide(e.currentSlide);
        renderAllMath(e.currentSlide);
        if (tenseMode){ addBuzzPillForSection(e.currentSlide); }
        
        // PATCH 4 Guard:
        if (isProblemSlide(e.currentSlide) && !e.currentSlide.dataset.flashcard){
          setupFlashcards();          // converts the current slide safely (setupFlashcards skips already-marked)
          renderAllMath(e.currentSlide);  // render KaTeX on both faces
        }
      });

      // PATCH 7: Keyboard shortcuts: D toggle double, T tense
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'd' || e.key === 'D'){ toggleDoublePoints(); }
        else if (e.key === 't' || e.key === 'T'){ toggleTenseMode(); }
        else if (e.key === 'ArrowDown') { selectNext(+1); }
        else if (e.key === 'ArrowUp')   { selectNext(-1); }
        else if ((e.key === '=' || e.key === '+') && selectedEntryId) { updateScore(selectedEntryId, 1000); }
        else if ((e.key === '-' || e.key === '_') && selectedEntryId) { updateScore(selectedEntryId, -1000); }
        else if (e.key === 'z' || e.key === 'Z') { undoLast(); }
      });
    });
  </script>
</body>
</html>
