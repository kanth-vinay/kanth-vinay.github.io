<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ActiveSTEM Extreme Math Challenge — 15 Questions in 15 Minutes</title>
    <meta name="description" content="ActiveSTEM Extreme Math Challenge — a 15‑minute, 15‑question diagnostic for students from early elementary to high school, built as a serious math lab experience." />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="ActiveSTEM Extreme Math Challenge" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@700;800;900&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            /* BRAND CORE */
            --brand-navy: #1A237E;
            --brand-green: #4CAF50;
            --brand-gold: #FFB300;

            /* THEME DEFAULTS */
            --bg: #F5F7FF;
            --panel: #FFFFFF;
            --ink: #1A237E;
            --sub: #475569;
            --accent: #4CAF50;
            --header-bg: #1A237E;
            --header-text: #FFFFFF;
            --line: #E0E3EC;
            --chip-bg: #E8EAF6;
            --chip-text: #1A237E;
            --meta-bg: #F8FAFC;
        }

        /* THEME 1: EARLY ELEMENTARY */
        [data-theme="Early Elementary"], [data-theme="Elementary"] {
            --bg: #FFF8E1;
            --panel: #FFFFFF;
            --ink: #3E2723;
            --sub: #5D4037;
            --accent: #F57C00;
            --header-bg: #E65100;
            --header-text: #FFFFFF;
            --line: #FFE0B2;
            --chip-bg: #FFF3E0;
            --chip-text: #E65100;
            --meta-bg: #FFFDE7;
        }

        /* THEME 2: MIDDLE SCHOOL */
        [data-theme="Middle"] {
            --bg: #F0F4F8;
            --panel: #FFFFFF;
            --ink: #102A43;
            --sub: #486581;
            --accent: #3366FF;
            --header-bg: #102A43;
            --header-text: #FFFFFF;
            --line: #D9E2EC;
            --chip-bg: #D9E2EC;
            --chip-text: #102A43;
            --meta-bg: #F0F4F8;
        }

        /* THEME 3: HIGH SCHOOL */
        [data-theme="High"] {
            --bg: #FAFAFA;
            --panel: #FFFFFF;
            --ink: #121212;
            --sub: #424242;
            --accent: #212121;
            --header-bg: #000000;
            --header-text: #FFFFFF;
            --line: #E0E0E0;
            --chip-bg: #ECEFF1;
            --chip-text: #263238;
            --meta-bg: #F5F5F5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            font-family: 'Inter', sans-serif;
            color: var(--ink);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.4s ease;
        }

        h1, h2, h3 { font-family: 'Poppins', sans-serif; font-weight: 800; margin: 0; }

        /* --- LAYOUT --- */
        .app-frame {
            flex: 1;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        .header {
            background: var(--header-bg);
            color: var(--header-text);
            padding: 0 1rem;
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: background-color 0.4s ease;
        }

        .header-branding {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            white-space: nowrap;
        }

        .brand-text {
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.5px;
        }

        .brand-site {
            font-weight: 400;
            font-size: 0.85rem;
            opacity: 0.8;
            font-family: 'Inter', sans-serif;
            display: none; 
        }

        @media (min-width: 600px) {
            .brand-text { font-size: 1.1rem; }
            .brand-site { display: inline; }
        }

        /* SAFETY FOR SMALL SCREENS */
        @media (max-width: 380px) {
            .brand-text { font-size: 0.85rem; }
            .header { padding: 0 0.8rem; }
            .timer-pill { padding: 4px 10px; font-size: 0.8rem; }
        }

        .header-tools {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timer-pill {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(4px);
            padding: 5px 14px;
            border-radius: 99px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9rem;
        }
        .timer-pill.warning {
            background: #FFEBEE;
            color: #D32F2F;
            border-color: #D32F2F;
            animation: pulse 1s infinite;
        }

        .build-pill {
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        @media (min-width: 400px) { .build-pill { display: inline-block; } }

        /* --- ANIMATED LOGO --- */
        .logo-animate-container {
            position: relative;
            display: inline-block;
            overflow: hidden;
        }
        .logo-std {
            font-family: 'Poppins', sans-serif;
            font-weight: 900;
            font-size: 2.5rem;
            letter-spacing: -1px;
        }
        .logo-std .b-active { color: var(--brand-navy); }
        .logo-std .b-stem { color: var(--brand-green); }
        
        .shimmer {
            background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.6) 50%, transparent 100%);
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            transform: skewX(-20deg);
            animation: shimmer 4s infinite ease-in-out;
            pointer-events: none;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            20% { left: 150%; }
            100% { left: 150%; }
        }

        /* --- CARDS --- */
        .card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            border-top: 4px solid var(--accent);
        }

        .meta-row {
            display: flex; gap: 8px; margin-bottom: 1.2rem; flex-wrap: wrap; align-items: center;
            font-family: 'Inter', sans-serif; border-bottom: 1px dashed var(--line); padding-bottom: 0.8rem;
        }
        .meta-tag {
            font-size: 0.65rem; font-weight: 600; text-transform: uppercase; padding: 3px 8px;
            background: var(--meta-bg); color: var(--sub); border-radius: 4px; border: 1px solid var(--line);
        }
        .meta-id { background: var(--ink); color: white; border-color: var(--ink); }

        .q-title {
            font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.15rem; color: var(--ink);
            margin-bottom: 1.5rem; line-height: 1.5;
        }

        .opt-label {
            display: flex; align-items: center; padding: 12px; border: 1px solid var(--line);
            border-radius: 6px; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; background: var(--panel);
        }
        .opt-label:hover { border-color: var(--accent); background: var(--bg); }
        input:checked + .opt-label { border-color: var(--accent); background-color: var(--bg); box-shadow: 0 0 0 1px var(--accent); }
        .opt-circle {
            min-width: 28px; width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--line);
            margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: var(--sub);
        }
        input:checked + .opt-label .opt-circle { background: var(--accent); border-color: var(--accent); color: var(--panel); }

        /* --- FORMS --- */
        input[type="text"], select {
            width: 100%; padding: 14px; border: 2px solid var(--line); border-radius: 8px;
            font-size: 1rem; margin-bottom: 1.5rem; background: var(--panel); color: var(--ink);
        }
        label { font-size: 0.85rem; font-weight: 700; color: var(--sub); margin-bottom: 0.5rem; display: block; text-transform: uppercase; letter-spacing: 0.5px; }

        .btn {
            width: 100%; padding: 16px; background: var(--accent); color: var(--panel);
            border: none; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer;
        }
        .btn:active { transform: scale(0.98); }

        /* --- MODAL (Generic) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-card {
            background: var(--panel); border-radius: 12px; padding: 2rem; max-width: 400px; width: 100%;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 1px solid var(--line);
        }
        .modal-icon { font-size: 2.5rem; color: var(--accent); margin-bottom: 1rem; }
        .modal-icon.warning { color: var(--brand-gold); }
        .modal-icon.danger { color: #D32F2F; }
        .modal-title { font-size: 1.2rem; font-weight: 800; color: var(--ink); margin-bottom: 0.5rem; font-family: 'Poppins'; }
        .modal-body { font-size: 0.95rem; color: var(--sub); margin-bottom: 1.5rem; line-height: 1.5; }

        /* --- SCORECARD --- */
        .score-card {
            background: var(--panel); border-radius: 16px; overflow: hidden; position: relative;
            border: 1px solid var(--line); box-shadow: 0 20px 50px rgba(0,0,0,0.15); width: 100%; max-width: 380px;
        }
        .score-header { height: 12px; background: linear-gradient(90deg, var(--brand-navy) 0%, var(--brand-green) 100%); }
        .watermark {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='150' height='150' viewBox='0 0 150 150' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-weight='bold' font-size='12' fill='%23000' opacity='0.03' transform='rotate(-45 75 75)' text-anchor='middle'%3Eactivestem.org%3C/text%3E%3C/svg%3E");
            pointer-events: none; z-index: 1;
        }
        .badge-icon {
            width: 72px; height: 72px; border-radius: 50%; margin: 0 auto 1rem;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #fff;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        .bg-gold { background: linear-gradient(135deg, #FFD700, #FFB300); }
        .bg-silver { background: linear-gradient(135deg, #E0E0E0, #B0BEC5); }
        .bg-bronze { background: linear-gradient(135deg, #D7CCC8, #A1887F); }
        .stat-box { background: var(--meta-bg); border-radius: 8px; padding: 12px; border: 1px solid var(--line); }
        
        /* Scorecard Footer */
        .sc-footer {
            border-top: 1px solid var(--line); padding: 0.8rem; font-size: 0.55rem; 
            color: var(--sub); background: var(--meta-bg); line-height: 1.4;
        }

        /* --- MAIN FOOTER --- */
        .footer { 
            text-align: center; padding: 2rem 1rem; color: var(--sub); font-size: 0.75rem; 
            margin-top: auto; border-top: 1px solid var(--line); background: var(--panel); line-height: 1.6;
        }
        .footer a { color: var(--accent); text-decoration: none; font-weight: 600; }

        /* UTILS */
        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="app-frame">
        
        <!-- 1. INTRO SCREEN -->
        <div id="view-intro" style="padding: 2rem; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <div style="margin-bottom: 2.5rem; text-align: center;">
                <div class="logo-animate-container">
                    <div class="brand-logo logo-std">
                        <span class="b-active">Active</span><span class="b-stem">STEM</span>
                    </div>
                    <div class="shimmer"></div>
                </div>
                <div style="font-size: 0.9rem; font-weight: 700; color: var(--sub); margin-top: 0.5rem; letter-spacing: 1px;">
                    Extreme Math Challenge
                </div>
                <div style="font-size: 0.8rem; color: var(--sub); margin-top: 0.4rem; max-width: 420px;">
                    A timed math lab benchmark — 15 questions in 15 minutes to stress‑test your problem solving and curiosity.
                </div>
            </div>

            <div id="msg-warning" class="card hidden" style="width: 100%; border-left: 4px solid var(--brand-gold); background: #FFF8E1; padding: 1rem;">
                <div style="font-size: 0.85rem; color: #856404; font-weight: 600;">
                    <i class="fas fa-history"></i> Previous attempt detected.
                </div>
            </div>

            <form id="form-start" class="card" style="width: 100%; max-width: 420px;">
                <label>Student Name</label>
                <input type="text" id="inp-name" required placeholder="Full Name">
                <label>Grade Level</label>
                <select id="inp-grade" required>
                    <option value="" disabled selected>Select Grade Level</option>
                    <option value="Early Elementary">Early Elementary (Grades 1-3)</option>
                    <option value="Elementary">Elementary (Grades 3-5)</option>
                    <option value="Middle">Middle School (Grades 6-8)</option>
                    <option value="High">High School (Grades 9-12)</option>
                </select>
                <button type="submit" class="btn">Proceed to Challenge <i class="fas fa-chevron-right ml-2"></i></button>
            </form>
        </div>

        <!-- READINESS MODAL -->
        <div id="modal-ready" class="modal-overlay hidden">
            <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-ready-title" aria-describedby="modal-ready-body">
                <div class="modal-icon"><i class="fas fa-pencil-alt"></i></div>
                <div class="modal-title" id="modal-ready-title">Readiness Check</div>
                <div class="modal-body" id="modal-ready-body">
                    This quiz requires you to work for <strong>15 minutes</strong> on 15 questions.<br><br>
                    Please have a <strong>pencil and paper</strong> ready for calculations.<br><br>
                    Are you ready to begin?
                </div>
                <button onclick="startQuizConfirmed()" class="btn" style="margin-bottom: 10px;">Yes, I am Ready</button>
                <button onclick="closeModal('modal-ready')" class="btn" style="background: transparent; border: 2px solid var(--line); color: var(--sub);">Go Back</button>
            </div>
        </div>

        <!-- UNANSWERED QUESTIONS MODAL -->
        <div id="modal-confirm-submit" class="modal-overlay hidden">
            <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-confirm-title" aria-describedby="modal-confirm-body">
                <div class="modal-icon warning"><i class="fas fa-exclamation-circle"></i></div>
                <div class="modal-title" id="modal-confirm-title">Incomplete Quiz</div>
                <div class="modal-body" id="modal-confirm-body">
                    You have <strong id="missing-count">0</strong> unanswered questions.<br><br>
                    Are you sure you want to submit your answers now?
                </div>
                <button onclick="finalizeSubmission()" class="btn" style="margin-bottom: 10px;">Yes, Submit Anyway</button>
                <button onclick="closeModal('modal-confirm-submit')" class="btn" style="background: transparent; border: 2px solid var(--line); color: var(--sub);">Go Back & Review</button>
            </div>
        </div>

        <!-- HISTORY WARNING MODAL -->
        <div id="modal-history" class="modal-overlay hidden">
            <div class="modal-card">
                <div class="modal-icon danger"><i class="fas fa-history"></i></div>
                <div class="modal-title">Previous Attempt Found</div>
                <div class="modal-body">
                    You have already taken this challenge on this device.<br><br>
                    Do you want to proceed with a re-attempt?
                </div>
                <button onclick="openReadinessCheck()" class="btn" style="margin-bottom: 10px;">Continue Anyway</button>
                <button onclick="closeModal('modal-history')" class="btn" style="background: transparent; border: 2px solid var(--line); color: var(--sub);">Cancel</button>
            </div>
        </div>

        <!-- 2. QUIZ SCREEN -->
        <div id="view-quiz" class="hidden">
            <header class="header">
                <div class="header-branding">
                    <div class="brand-text">ActiveSTEM • Extreme Math Challenge</div>
                    <span class="brand-site">• www.activestem.org</span>
                </div>
                <div class="header-tools">
                    <div id="timer" class="timer-pill" aria-live="polite" aria-label="Time remaining 15 minutes 0 seconds">15:00</div>
                    <div id="header-build" class="build-pill"></div>
                </div>
            </header>
            
            <div id="quiz-container" style="padding: 1.5rem; padding-bottom: 6rem;">
                <!-- Questions -->
            </div>
            
            <div style="position: fixed; bottom: 0; left: 0; width: 100%; background: var(--panel); padding: 1rem; border-top: 1px solid var(--line); z-index: 90; display: flex; justify-content: center;">
                <button onclick="submitQuiz()" class="btn" style="max-width: 600px;">Submit & Finish</button>
            </div>
        </div>

        <!-- 3. RESULT SCREEN -->
        <div id="view-result" class="hidden" style="padding: 2rem; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div id="final-card" class="score-card">
                <div class="score-header"></div>
                <div class="watermark"></div>
                <div style="padding: 2rem; position: relative; z-index: 2; text-align: center; padding-bottom: 1rem;">
                    <div class="brand-logo logo-std" style="font-size: 1.6rem; margin-bottom: 4px;">
                        <span class="b-active">Active</span><span class="b-stem">STEM</span>
                    </div>
                    <div style="font-size: 0.7rem; font-weight: 700; color: var(--brand-green); margin-bottom: 1.5rem;">
                        activestem.org • Official Report
                    </div>
                    
                    <h2 id="res-name" style="color: var(--ink); font-size: 1.5rem;"></h2>
                    <div id="res-grade" style="display: inline-block; background: var(--chip-bg); color: var(--chip-text); padding: 4px 12px; border-radius: 99px; font-size: 0.7rem; font-weight: 700; margin-top: 8px; text-transform: uppercase;"></div>
                    
                    <div id="badge-area" style="margin: 1.5rem 0;"></div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="stat-box">
                            <div id="res-score" style="font-family: 'Poppins'; font-weight: 700; font-size: 1.4rem; color: var(--ink);"></div>
                            <div style="font-size: 0.65rem; text-transform: uppercase; color: var(--sub); letter-spacing: 1px;">Accuracy</div>
                        </div>
                        <div class="stat-box">
                            <div id="res-time" style="font-family: 'Poppins'; font-weight: 700; font-size: 1.4rem; color: var(--ink);"></div>
                            <div style="font-size: 0.65rem; text-transform: uppercase; color: var(--sub); letter-spacing: 1px;">Time Taken</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; font-family: monospace; font-size: 0.6rem; color: var(--sub); margin-bottom: 1rem;">
                        ID: <span id="res-id"></span>
                    </div>
                </div>
                <div class="sc-footer">
                    Active Learning Institute LLC — www.activestem.org<br>
                    © 2025 Active Learning Institute LLC. All Rights Reserved.<br>
                    Platform Structure available under MIT License. Content © Active Learning Institute.
                </div>
            </div>
            <div style="margin-top: 2rem; width: 100%; max-width: 380px;">
                <button onclick="shareWhatsapp()" class="btn" style="background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i class="fab fa-whatsapp" style="font-size: 1.2rem;"></i> Share Results
                </button>
            </div>
        </div>

        <footer class="footer">
            <div style="font-weight: 600; margin-bottom: 4px;">
                Active Learning Institute LLC — <a href="https://www.activestem.org" target="_blank">www.activestem.org</a>
            </div>
            <div>
                &copy; <span id="year"></span> Active Learning Institute LLC. All Rights Reserved.
            </div>
            <div style="opacity: 0.6; margin-top: 6px;">
                Platform Structure available under MIT License. Content © Active Learning Institute.
            </div>
            <div style="opacity: 0.7; margin-top: 4px;">
                Designed as a diagnostic math lab experience that complements school learning and regular homework.
            </div>
            <div id="footer-build" style="font-family: monospace; margin-top: 8px; opacity: 0.4; font-size: 0.65rem;"></div>
        </footer>
    </div>

    <script>
        // --- SYSTEM CONFIG ---
        const APP_ID = 'activestem_extreme_v15';
        const TIME_LIMIT = 15; // Minutes

        // Build Number
        const now = new Date();
        const buildString = `Build ${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}.RC${Math.floor(Math.random()*100)}`;
        document.getElementById('header-build').innerText = buildString;
        document.getElementById('footer-build').innerText = `${buildString} • PILOT VERSION`;
        document.getElementById('year').innerText = now.getFullYear();

        // --- QUESTION BANKS BY GRADE ---
        const QUESTION_DB = {
            "Early Elementary": [
                { id: "EE-01", topic: "Order Data", q: "Arrange these heights: 45cm, 32cm, 50cm, 41cm. Which is the median (middle) value if you had 5 students and the 5th was 40cm?", opts: ["40cm", "41cm", "45cm", "32cm"], ans: 1, intent: "Ordering and median concept." },
                { id: "EE-02", topic: "Fractions", q: "Order from smallest to largest: \\(\\frac{1}{2}, \\frac{1}{8}, \\frac{1}{4}\\)", opts: ["1/2, 1/4, 1/8", "1/8, 1/4, 1/2", "1/8, 1/2, 1/4", "1/4, 1/8, 1/2"], ans: 1, intent: "Understanding unit fractions." },
                { id: "EE-03", topic: "Arithmetic", q: "Calculate: \\( 10 + 5 + 10 + 5 + 8 \\)", opts: ["28", "38", "48", "35"], ans: 1, intent: "Grouping strategy (10+10, 5+5)." },
                { id: "EE-04", topic: "Logic", q: "If 3 red blocks balance 1 blue block, and 2 blue blocks balance 1 green block, how many red blocks equal 1 green block?", opts: ["3", "5", "6", "9"], ans: 2, intent: "Transitive reasoning." },
                { id: "EE-05", topic: "Time", q: "A movie starts at 2:15 PM and is 90 minutes long. When does it end?", opts: ["3:15 PM", "3:30 PM", "3:45 PM", "4:15 PM"], ans: 2, intent: "Time conversion." },
                { id: "EE-06", topic: "Measurement", q: "Which is longer? A: 100cm, B: 1 meter, C: 1 yard", opts: ["A is longest", "B is longest", "C is longest", "A and B are equal"], ans: 3, intent: "Metric/Imperial estimation (1 yd = 0.91m)." },
                { id: "EE-07", topic: "Patterns", q: "2, 5, 8, 11, ... What is the 10th number?", opts: ["29", "30", "32", "27"], ans: 0, intent: "Linear patterns." },
                { id: "EE-08", topic: "Geometry", q: "How many vertices (corners) does a cube have?", opts: ["6", "8", "10", "12"], ans: 1, intent: "3D shape properties." },
                { id: "EE-09", topic: "Money", q: "Make 85 cents using the fewest coins (Quarters, Dimes, Nickels).", opts: ["3 Q, 1 D", "3 Q, 2 N", "2 Q, 3 D, 1 N", "4 Q"], ans: 0, intent: "Optimization." },
                { id: "EE-10", topic: "Operations", q: "I think of a number, add 5, and get 12. What is my number?", opts: ["5", "6", "7", "17"], ans: 2, intent: "Algebraic thinking." },
                { id: "EE-11", topic: "Data", q: "A has 5 apples. B has twice as many. C has 3 less than B. How many does C have?", opts: ["7", "10", "13", "8"], ans: 0, intent: "Multi-step word problem." },
                { id: "EE-12", topic: "Place Value", q: "Which is equal to 4 hundreds, 15 tens, and 6 ones?", opts: ["4156", "556", "456", "465"], ans: 1, intent: "Regrouping tens to hundreds." },
                { id: "EE-13", topic: "Logic", q: "I am an odd number between 10 and 20. I am divisible by 3. Who am I?", opts: ["12", "15", "18", "21"], ans: 1, intent: "Number properties." },
                { id: "EE-14", topic: "Fractions", q: "What is half of a half?", opts: ["1/2", "1/4", "1/8", "1"], ans: 1, intent: "Conceptual multiplication." },
                { id: "EE-15", topic: "Geometry", q: "Which letter has a vertical line of symmetry? A, F, G, P", opts: ["A", "F", "G", "P"], ans: 0, intent: "Spatial reasoning." }
            ],
            "Elementary": [
                { id: "EL-01", topic: "Fractions", q: "Evaluate: \\( 2\\frac{1}{2} + 3\\frac{1}{4} - 1\\frac{1}{8} \\)", opts: ["\\( 4\\frac{5}{8} \\)", "\\( 4\\frac{3}{4} \\)", "\\( 5\\frac{1}{8} \\)", "\\( 4\\frac{7}{8} \\)"], ans: 0, intent: "Mixed number fluency." },
                { id: "EL-02", topic: "PEMDAS", q: "Evaluate: \\( 100 - 3 \\times (5 + 4^2) \\)", opts: ["37", "25", "17", "2037"], ans: 0, intent: "Exponents inside parenthesis." },
                { id: "EL-03", topic: "Comparison", q: "Compare A: \\( \\frac{3}{4} + \\frac{1}{2} \\) vs B: \\( \\frac{5}{4} \\)", opts: ["A > B", "A < B", "A = B", "Impossible"], ans: 2, intent: "Equivalence recognition." },
                { id: "EL-04", topic: "Percents", q: "What is 50% of 50% of 200?", opts: ["100", "50", "25", "10"], ans: 1, intent: "Percent of percent." },
                { id: "EL-05", topic: "Algebra", q: "Solve for x: \\( 3x + 7 = 22 \\)", opts: ["3", "4", "5", "6"], ans: 2, intent: "Two-step equation." },
                { id: "EL-06", topic: "Geometry", q: "Area of a rectangle is 24. Perimeter is 20. What are the sides?", opts: ["4, 6", "3, 8", "2, 12", "1, 24"], ans: 0, intent: "Factors and sums." },
                { id: "EL-07", topic: "Factors", q: "What is the GCF of 24 and 36?", opts: ["6", "8", "12", "24"], ans: 2, intent: "Greatest Common Factor." },
                { id: "EL-08", topic: "Ratios", q: "If 5 books cost $45, how much do 3 books cost?", opts: ["$27", "$30", "$25", "$15"], ans: 0, intent: "Unitary method." },
                { id: "EL-09", topic: "Decimals", q: "Compute: \\( 3.45 + 0.6 - 1.05 \\)", opts: ["3.00", "3.10", "2.90", "3.05"], ans: 0, intent: "Decimal arithmetic." },
                { id: "EL-10", topic: "Logic", q: "In a class of 20, 12 like Math, 10 like Science, 4 like neither. How many like both?", opts: ["2", "4", "6", "8"], ans: 2, intent: "Set theory." },
                { id: "EL-11", topic: "Measurement", q: "How many 2cm cubes fit in a 4cm x 4cm x 4cm box?", opts: ["4", "6", "8", "16"], ans: 2, intent: "Volume scaling." },
                { id: "EL-12", topic: "Patterns", q: "1, 4, 9, 16, ... What is the 7th term?", opts: ["25", "36", "49", "64"], ans: 2, intent: "Quadratic sequence." },
                { id: "EL-13", topic: "Probability", q: "Probability of rolling a prime number on a standard die?", opts: ["1/2", "1/3", "1/6", "2/3"], ans: 0, intent: "Primes: 2, 3, 5." },
                { id: "EL-14", topic: "Time", q: "Start: 10:45 AM. End: 1:20 PM. How long?", opts: ["2h 15m", "2h 35m", "3h 35m", "2h 45m"], ans: 1, intent: "Base-60 arithmetic." },
                { id: "EL-15", topic: "Coordinates", q: "Distance between (2, 3) and (2, 8)?", opts: ["3", "4", "5", "6"], ans: 2, intent: "Vertical distance." }
            ],
            "Middle": [
                { id: "MID-01", topic: "Extreme Algebra", q: "Evaluate: \\( 1 + \\frac{1}{1+\\frac{1}{2}} \\)", opts: ["\\( \\frac{5}{3} \\)", "\\( \\frac{3}{2} \\)", "\\( \\frac{4}{3} \\)", "\\( 2 \\)"], ans: 0, intent: "Collapse from bottom up." },
                { id: "MID-02", topic: "Radicals", q: "Simplify: \\( \\sqrt{50} + \\sqrt{18} \\)", opts: ["\\( 8\\sqrt{2} \\)", "\\( \\sqrt{68} \\)", "\\( 5\\sqrt{2} \\)", "\\( 34 \\)"], ans: 0, intent: "Factor squares." },
                { id: "MID-03", topic: "Exponents", q: "Simplify: \\( (2x^2)^3 \\cdot x^{-4} \\)", opts: ["\\( 8x^2 \\)", "\\( 6x^2 \\)", "\\( 8x \\)", "\\( 2x^2 \\)"], ans: 0, intent: "Distribute power then add." },
                { id: "MID-04", topic: "Linear Eq", q: "Solve: \\( 2(x-3) - 3(x+1) = -5 \\)", opts: ["-2", "-4", "4", "2"], ans: 1, intent: "Negative distribution." },
                { id: "MID-05", topic: "Geometry", q: "A ladder 13ft long is 5ft from the wall. How high does it reach?", opts: ["8 ft", "10 ft", "12 ft", "14 ft"], ans: 2, intent: "5-12-13 Triples." },
                { id: "MID-06", topic: "Percents", q: "A price increased by 20% is now $120. What was the original price?", opts: ["$96", "$100", "$144", "$110"], ans: 1, intent: "1.2x = 120." },
                { id: "MID-07", topic: "Coordinates", q: "Distance between (-1, -1) and (2, 3)?", opts: ["3", "4", "5", "7"], ans: 2, intent: "3-4-5 Triangle." },
                { id: "MID-08", topic: "Inequalities", q: "Solve: \\( -3x + 5 > 14 \\)", opts: ["\\( x > -3 \\)", "\\( x < -3 \\)", "\\( x > 3 \\)", "\\( x < 3 \\)"], ans: 1, intent: "Divide by negative." },
                { id: "MID-09", topic: "Slope", q: "Slope of line passing through (1, 2) and (4, 8)?", opts: ["2", "1/2", "3", "6"], ans: 0, intent: "Slope formula." },
                { id: "MID-10", topic: "System", q: "Solve: \\( y=2x \\) and \\( x+y=12 \\)", opts: ["(4, 8)", "(3, 6)", "(2, 4)", "(6, 12)"], ans: 0, intent: "System of equations." },
                { id: "MID-11", topic: "Scientific Not.", q: "Compute: \\( (2 \\times 10^3) \\times (3 \\times 10^5) \\)", opts: ["\\( 6 \\times 10^8 \\)", "\\( 5 \\times 10^8 \\)", "\\( 6 \\times 10^{15} \\)", "\\( 5 \\times 10^{15} \\)"], ans: 0, intent: "Add exponents." },
                { id: "MID-12", topic: "Probability", q: "P(Heads) AND P(Rolling 6)?", opts: ["1/6", "1/8", "1/12", "1/2"], ans: 2, intent: "Multiply probabilities." },
                { id: "MID-13", topic: "Statistics", q: "Mean of 4 numbers is 10. Three are 8, 12, 5. What is the fourth?", opts: ["10", "15", "12", "25"], ans: 1, intent: "Sum = 40." },
                { id: "MID-14", topic: "Polynomials", q: "Expand: \\( (x+3)(x-4) \\)", opts: ["\\( x^2-x-12 \\)", "\\( x^2-7x-12 \\)", "\\( x^2+x-12 \\)", "\\( x^2-12 \\)"], ans: 0, intent: "Binomial multiplication." },
                { id: "MID-15", topic: "Volume", q: "Volume of cylinder, r=2, h=5? (\\(\\pi \\approx 3\\))", opts: ["30", "60", "20", "12"], ans: 1, intent: "V = pi*r^2*h." }
            ],
            "High": [
                { id: "HS-01", topic: "Rational Exp", q: "Simplify: \\( \\frac{x^2-9}{x-3} \\) (Assume \\(x \\neq 3\\))", opts: ["\\( x-3 \\)", "\\( x+3 \\)", "\\( x+9 \\)", "\\( x^2 \\)"], ans: 1, intent: "Factoring Difference of Squares." },
                { id: "HS-02", topic: "Polynomials", q: "Find the remainder when \\( 2x^3 - 4x^2 + x - 5 \\) is divided by \\( x-2 \\).", opts: ["-5", "-3", "1", "0"], ans: 1, intent: "Remainder Theorem / Synthetic Division." },
                { id: "HS-03", topic: "Nonlinear Sys", q: "Solve for \\( x \\): \\( y = x^2 \\) and \\( y = 2x + 3 \\)", opts: ["-1, 3", "-3, 1", "0, 2", "1, 2"], ans: 0, intent: "Quadratic intersection." },
                { id: "HS-04", topic: "Logarithms", q: "Solve: \\( \\log_2(x) + \\log_2(4) = 5 \\)", opts: ["4", "8", "16", "32"], ans: 1, intent: "Log properties." },
                { id: "HS-05", topic: "Functions", q: "If \\( f(x)=2x \\) and \\( g(x)=x+1 \\), find \\( f(g(3)) \\).", opts: ["7", "8", "6", "5"], ans: 1, intent: "Composite functions." },
                { id: "HS-06", topic: "Quadratics", q: "Find the vertex of \\( y = (x-2)^2 + 5 \\).", opts: ["(-2, 5)", "(2, 5)", "(2, -5)", "(5, 2)"], ans: 1, intent: "Vertex form." },
                { id: "HS-07", topic: "Complex Num", q: "Evaluate: \\( i^2 \\)", opts: ["1", "-1", "i", "-i"], ans: 1, intent: "Definition of imaginary unit." },
                { id: "HS-08", topic: "Combinatorics", q: "How many distinct ways can you arrange the letters in 'APPLE'?", opts: ["120", "60", "24", "100"], ans: 1, intent: "Permutations with repetition." },
                { id: "HS-09", topic: "Inequalities", q: "Solve: \\( |2x - 5| < 7 \\)", opts: ["\\( -1 < x < 6 \\)", "\\( x < 6 \\)", "\\( x > -1 \\)", "\\( x < -1 \\text{ or } x > 6 \\)"], ans: 0, intent: "Absolute value inequality." },
                { id: "HS-10", topic: "Sequences", q: "Sum of infinite series: \\( 1 + 1/2 + 1/4 + ... \\)", opts: ["1.5", "2", "2.5", "Infinity"], ans: 1, intent: "Infinite Geometric Series." },
                { id: "HS-11", topic: "Circle Eq", q: "Find the center \\((h, k)\\) and radius \\(r\\) of the circle: \\(x^2 + y^2 - 4x + 6y - 12 = 0\\)", opts: ["\\( (2, -3), r=5 \\)", "\\( (-2, 3), r=5 \\)", "\\( (2, -3), r=25 \\)", "\\( (4, -6), r=12 \\)"], ans: 0, intent: "Completing the square." },
                { id: "HS-12", topic: "Optimization", q: "Max area of a rectangle with perimeter 20?", opts: ["20", "24", "25", "100"], ans: 2, intent: "Quadratic optimization." },
                { id: "HS-13", topic: "Domain", q: "Domain of \\( f(x) = \\sqrt{x-4} \\)", opts: ["\\( x > 4 \\)", "\\( x \\ge 4 \\)", "\\( x \\neq 4 \\)", "All Reals"], ans: 1, intent: "Square root restriction." },
                { id: "HS-14", topic: "Radicals", q: "Simplify \\( \\sqrt[3]{8x^6y^9} \\)", opts: ["\\( 2x^2y^3 \\)", "\\( 2x^3y^3 \\)", "\\( 4x^2y^3 \\)", "\\( 2xy \\)"], ans: 0, intent: "Rational exponents." },
                { id: "HS-15", topic: "Logic", q: "Contrapositive of 'If P then Q'?", opts: ["If Q then P", "If not P then not Q", "If not Q then not P", "If P then not Q"], ans: 2, intent: "Logic equivalence." }
            ]
        };

        // --- STATE ---
        let currentQuestions = [];
        let userAnswers = [];
        let timerInterval;
        let secondsLeft = TIME_LIMIT * 60;
        let startTime;
        let userData = { name: '', grade: '' };

        // Init
        if(localStorage.getItem(APP_ID)) {
            // Do not use native alert, rely on modal logic in form submit
        }

        // --- FUNCTIONS ---
        
        // Helper to close generic modals
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // 1. Start Process
        document.getElementById('form-start').addEventListener('submit', (e) => {
            e.preventDefault();
            userData.name = document.getElementById('inp-name').value;
            userData.grade = document.getElementById('inp-grade').value;
            
            if(localStorage.getItem(APP_ID)) {
                // Show Previous Attempt Modal
                document.getElementById('modal-history').classList.remove('hidden');
            } else {
                openReadinessCheck();
            }
        });

        function openReadinessCheck() {
            closeModal('modal-history');
            document.getElementById('modal-ready').classList.remove('hidden');
        }

        // 2. Actually Start Quiz
        function startQuizConfirmed() {
            document.getElementById('modal-ready').classList.add('hidden');
            
            // Apply Theme
            const themeName = userData.grade.includes('Early') ? 'Early Elementary' : 
                             userData.grade.includes('Elementary') ? 'Elementary' :
                             userData.grade.includes('Middle') ? 'Middle' : 'High';
            document.documentElement.setAttribute('data-theme', themeName);

            // Load Questions
            currentQuestions = QUESTION_DB[themeName] || QUESTION_DB["Elementary"];
            userAnswers = new Array(currentQuestions.length).fill(null);

            renderQuiz();
            document.getElementById('view-intro').classList.add('hidden');
            document.getElementById('view-quiz').classList.remove('hidden');
            window.scrollTo(0,0);
            
            startTime = new Date();
            startTimer();
        }

        // MathJax Helper
        function typesetMath() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise();
            } else {
                setTimeout(() => {
                    if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise();
                }, 500);
            }
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = currentQuestions.map((q, idx) => `
                <div class="card">
                    <div class="meta-row">
                        <span class="meta-tag meta-id">${q.id}</span>
                        <span class="meta-tag">${q.topic}</span>
                        <span class="meta-tag" style="margin-left:auto">Time: 1 min</span>
                    </div>
                    <div class="q-title">
                        <span style="color:var(--accent); margin-right:8px;">${idx+1}.</span>${q.q}
                    </div>
                    <div>
                        ${q.opts.map((opt, oIdx) => `
                            <div style="position:relative">
                                <input type="radio" name="q${idx}" id="q${idx}_${oIdx}" 
                                    style="display:none" onchange="recordAnswer(${idx}, ${oIdx})">
                                <label for="q${idx}_${oIdx}" class="opt-label">
                                    <div class="opt-circle">${String.fromCharCode(65+oIdx)}</div>
                                    <div style="font-size:0.95rem">${opt}</div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            typesetMath();
        }

        function recordAnswer(qIdx, oIdx) {
            userAnswers[qIdx] = oIdx;
        }

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                secondsLeft--;
                updateTimerDisplay();
                if(secondsLeft <= 0) {
                    clearInterval(timerInterval);
                    finalizeSubmission();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(secondsLeft / 60);
            const s = secondsLeft % 60;
            const el = document.getElementById('timer');
            el.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if(secondsLeft < 60) el.classList.add('warning');
        }

        // New Submit Logic with Custom Modal
        window.submitQuiz = function() {
            const missing = userAnswers.filter(a => a === null).length;
            
            if(missing > 0) {
                // Show custom warning modal instead of browser confirm
                document.getElementById('missing-count').innerText = missing;
                document.getElementById('modal-confirm-submit').classList.remove('hidden');
            } else {
                // No missing answers, proceed directly
                finalizeSubmission();
            }
        }

        function finalizeSubmission() {
            // Hide modal if open
            document.getElementById('modal-confirm-submit').classList.add('hidden');
            
            clearInterval(timerInterval);
            let score = 0;
            userAnswers.forEach((a, i) => { if(a === currentQuestions[i].ans) score++; });
            const timeUsed = (new Date() - startTime) / 1000;
            const m = Math.floor(timeUsed / 60);
            const s = Math.floor(timeUsed % 60);
            const timeStr = `${m}m ${s}s`;

            localStorage.setItem(APP_ID, JSON.stringify({
                ...userData, score, time: timeStr, date: new Date().toISOString()
            }));

            showResult(score, timeStr);
        }

        function showResult(score, timeStr) {
            document.getElementById('view-quiz').classList.add('hidden');
            document.getElementById('view-result').classList.remove('hidden');
            document.getElementById('res-name').innerText = userData.name;
            document.getElementById('res-grade').innerText = userData.grade;
            document.getElementById('res-score').innerText = `${score}/${currentQuestions.length}`;
            document.getElementById('res-time').innerText = timeStr;
            document.getElementById('res-id').innerText = `REF-${Math.random().toString(36).substr(2,8).toUpperCase()}`;

            // Badge Logic - Updated to Academic Terms
            const badgeContainer = document.getElementById('badge-area');
            let icon = 'fa-lightbulb'; 
            let bgClass = 'bg-bronze'; 
            let title = 'Math Lab Explorer';

            if(score === 15) { 
                icon = 'fa-atom'; 
                bgClass = 'bg-gold'; 
                title = 'ActiveSTEM Distinction'; 
            } else if (score >= 12) { 
                icon = 'fa-square-root-variable'; 
                bgClass = 'bg-silver'; 
                title = 'Math Lab Specialist'; 
            }

            badgeContainer.innerHTML = `
                <div class="badge-icon ${bgClass}"><i class="fas ${icon}"></i></div>
                <div style="font-family:'Poppins'; font-weight:800; font-size:1.2rem; text-transform:uppercase; color:var(--ink);">${title}</div>
                <div style="font-size:0.7rem; color:var(--sub); margin-top:4px;">ActiveSTEM Achievement</div>
            `;
            if(score > 8) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        window.shareWhatsapp = function() {
            const score = document.getElementById('res-score').innerText;
            const text = `⚡ ActiveSTEM Result\nName: ${userData.name}\nScore: ${score}\nTry it at activestem.org`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }
    </script>
</body>
</html>
